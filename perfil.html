<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Meu Perfil ID1</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      text-align: center;
      background: #eef2f6; /* Fundo mais suave */
      color: #333;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      background: #2c3e50; /* Cor escura do cabe√ßalho */
      color: white;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    header .header-left {
      display: flex;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-size: 1.8rem;
      margin-left: 15px; /* Espa√ßo entre o √≠cone e o t√≠tulo */
    }
    header button {
      background: #e74c3c; /* Vermelho para sair */
      color: white;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.3s ease;
    }
    header button:hover {
      background-color: #c0392b;
    }

    /* √çcone de Perfil no Header */
    .profile-icon-header {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #4a90e2; /* Cor de fundo para placeholder */
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.5rem;
      color: white;
      cursor: pointer;
      border: 2px solid white; /* Borda branca */
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }
    .profile-icon-header:hover {
      transform: scale(1.05);
      box-shadow: 0 0 8px rgba(0,0,0,0.5);
    }
    .profile-icon-header::before {
      content: "üë§"; /* √çcone de usu√°rio simples */
    }

    main {
      flex-grow: 1;
      padding: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }

    /* Estilos das Abas */
    .tabs-container {
      width: 100%;
      max-width: 900px;
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      margin-top: 20px;
    }

    .tab-buttons {
      display: flex;
      border-bottom: 1px solid #ddd;
    }
    .tab-button {
      flex: 1;
      padding: 15px 0;
      cursor: pointer;
      font-size: 1.1rem;
      font-weight: bold;
      color: #555;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
    }
    .tab-button:hover {
      color: #4a90e2;
    }
    .tab-button.active {
      color: #4a90e2;
      border-bottom: 3px solid #4a90e2;
      background-color: #f9f9f9;
    }

    .tab-content {
      padding: 30px;
      text-align: left;
    }
    .tab-content.hidden {
      display: none;
    }

    /* Estilos dos Cards (dentro das abas) */
    .profile-card, .info-card {
      background: #ffffff;
      padding: 0;
      border-radius: 8px;
      box-shadow: none;
      width: 100%;
      max-width: 800px;
      margin: 0 auto;
      text-align: left;
    }
    .profile-card h2, .info-card h2 {
      color: #34495e;
      margin-bottom: 25px;
      text-align: center;
      font-size: 2rem;
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #555;
      font-size: 1.05rem;
    }
    input[type="text"],
    input[type="email"],
    input[type="date"] {
      width: calc(100% - 22px);
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
      font-size: 1rem;
    }
    input[type="email"][readonly] {
      background-color: #f0f0f0;
      cursor: not-allowed;
    }
    .button-save {
      background: #28a745;
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1.1rem;
      transition: background-color 0.3s ease, transform 0.2s ease;
      width: auto;
      margin-top: 20px;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    .button-save:hover {
      background-color: #218838;
      transform: translateY(-2px);
    }
    .status-message {
      margin-top: 20px;
      font-size: 1rem;
      color: #e74c3c;
      text-align: center;
      font-weight: bold;
    }
    .success-message {
        color: #27ae60;
    }
    footer {
      background: #2c3e50;
      color: white;
      padding: 1rem;
      margin-top: auto;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
    }

    /* Estilo para o √≠cone de informa√ß√£o com popup */
    .info-icon-container {
      position: relative;
      display: inline-block;
      margin-left: 10px;
      cursor: pointer;
    }
    .info-icon {
      font-size: 1.2rem;
      color: #4a90e2;
      vertical-align: middle;
    }
    .info-popup {
      visibility: hidden;
      width: 250px;
      background-color: #555;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 10px;
      position: absolute;
      z-index: 1;
      bottom: 125%; /* Acima do √≠cone */
      left: 50%;
      margin-left: -125px; /* Centraliza o popup */
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 0.9rem;
    }
    .info-popup::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: #555 transparent transparent transparent;
    }
    .info-icon-container:hover .info-popup {
      visibility: visible;
      opacity: 1;
    }

    /* Estilos para homenagens e rel√≥gios */
    .time-section {
      background: #fdfdfd;
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      text-align: center;
    }
    .time-section h3 {
      color: #34495e;
      margin-bottom: 15px;
      font-size: 1.6rem;
    }
    .time-details p {
      font-size: 1.2rem;
      color: #444;
      margin-bottom: 5px;
    }
    .clock-display {
      font-family: 'Consolas', 'Courier New', monospace;
      font-size: 1.8rem;
      color: #2c3e50;
      font-weight: bold;
      letter-spacing: 1px;
      margin-top: 10px;
      background: #e0e6ec;
      padding: 10px;
      border-radius: 5px;
      display: inline-block;
    }
    .small-text {
      font-size: 0.9rem;
      color: #777;
    }
    .bold-value {
        font-weight: bold;
        color: #007bff; /* Azul para destacar valores */
    }
  </style>
</head>
<body>
  <header>
    <div class="header-left">
      <div class="profile-icon-header" id="headerProfileIcon" title="Meu Perfil"></div>
      <h1>ID1: Identidade Digital Evoluzion</h1>
    </div>
    <button id="logoutButton">Sair</button>
  </header>

  <main>
    <div class="tabs-container">
      <div class="tab-buttons">
        <button class="tab-button" data-tab="profile">Meu Perfil</button>
        <button class="tab-button" data-tab="documents">Carteira de Documentos</button>
        <button class="tab-button" data-tab="tvv">TVV</button>
        <button class="tab-button" data-tab="tvt">TVT</button>
        <button class="tab-button" data-tab="tvdt">TVDT</button>
      </div>

      <div id="profile-content" class="tab-content hidden">
        <h2>Meus Dados
          <div class="info-icon-container">
            <span class="info-icon">‚ÑπÔ∏è</span>
            <div class="info-popup">
              Esta se√ß√£o permite que voc√™ visualize e edite suas informa√ß√µes pessoais. Seus dados s√£o armazenados de forma segura e utilizados para personalizar sua experi√™ncia.
            </div>
          </div>
        </h2>
        <p id="status" class="status-message"></p>

        <div class="form-group">
          <label for="nameInput">Nome Completo:</label>
          <input type="text" id="nameInput" placeholder="Seu Nome">
        </div>

        <div class="form-group">
          <label for="emailInput">E-mail:</label>
          <input type="email" id="emailInput" readonly>
          <small style="color: #666; display: block; margin-top: 5px;">Este campo n√£o pode ser alterado aqui.</small>
        </div>

        <div class="form-group">
          <label for="dateOfBirthInput">Data de Nascimento:</label>
          <input type="date" id="dateOfBirthInput">
        </div>

        <div class="form-group">
          <label for="placeOfBirthInput">Local de Nascimento:</label>
          <input type="text" id="placeOfBirthInput" placeholder="Cidade, Pa√≠s">
        </div>

        <button id="saveProfileButton" class="button-save">Salvar Perfil</button>
      </div>

      <div id="documents-content" class="tab-content hidden">
        <h2>Carteira de Documentos
          <div class="info-icon-container">
            <span class="info-icon">‚ÑπÔ∏è</span>
            <div class="info-popup">
              Sua carteira digital para armazenar e gerenciar documentos importantes de forma segura e acess√≠vel, onde quer que voc√™ esteja. Recurso em desenvolvimento.
            </div>
          </div>
        </h2>
        <p>Sua carteira digital universal para documentos est√° em desenvolvimento.</p>
        <p>Em breve, voc√™ poder√° armazenar e acessar seus documentos de forma segura aqui.</p>
      </div>

      <div id="tvv-content" class="tab-content hidden">
        <h2>TVV (Tempo de Vida Vivido)
          <div class="info-icon-container">
            <span class="info-icon">‚ÑπÔ∏è</span>
            <div class="info-popup">
              Aqui voc√™ pode ver uma contagem em tempo real de quanto tempo voc√™ viveu (se a data de nascimento estiver preenchida), al√©m de uma homenagem √† pessoa que mais viveu na hist√≥ria.
            </div>
          </div>
        </h2>

        <div class="time-section" id="myLifeCounterSection">
          <h3>Seu Tempo de Vida Real</h3>
          <p class="small-text">(Baseado na sua Data de Nascimento preenchida no Perfil)</p>
          <div class="clock-display" id="myLifeClock">
            <span id="myLifeYears">00</span>a <span id="myLifeMonths">00</span>m <span id="myLifeDays">00</span>d <span id="myLifeHours">00</span>h <span id="myLifeMinutes">00</span>m <span id="myLifeSeconds">00</span>s <span id="myLifeMilliseconds">000</span>ms
          </div>
          <p class="small-text" id="myLifeTotalValues">
            Voc√™ j√° viveu um total de <span class="bold-value" id="myLifeTotalYears">0</span> anos, 
            <span class="bold-value" id="myLifeTotalMonths">0</span> meses e 
            <span class="bold-value" id="myLifeTotalDays">0</span> dias.
          </p>
        </div>

        <div class="time-section">
          <h3>Homenagem a Jeanne Calment</h3>
          <p>A pessoa com a vida mais longa verificada na hist√≥ria.</p>
          <div class="time-details">
            <p><strong>Nome:</strong> Jeanne Louise Calment</p>
            <p><strong>Viveu:</strong> <span id="calmentYears"></span> anos, <span id="calmentMonths"></span> meses e <span id="calmentDays"></span> dias</p>
            <p class="small-text">(Total de: <span class="bold-value" id="calmentTotalYears"></span> anos | <span class="bold-value" id="calmentTotalMonths"></span> meses | <span class="bold-value" id="calmentTotalDays"></span> dias)</p>
          </div>
        </div>
      </div>

      <div id="tvt-content" class="tab-content hidden">
        <h2>TVT (Tempo de Vida Token)
          <div class="info-icon-container">
            <span class="info-icon">‚ÑπÔ∏è</span>
            <div class="info-popup">
              O TVT √© o Tempo de Vida Token, uma medida baseada na maior longevidade j√° registrada, acrescida de um dia. Representa um valor de refer√™ncia para a potencialidade da vida.
            </div>
          </div>
        </h2>
        <p>Acompanhe o Tempo de Vida Token, que representa a maior longevidade j√° registrada, acrescida de um dia!</p>
        <div class="time-section">
          <h3>C√°lculo do TVT</h3>
          <p>F√≥rmula: (MAIOR LONGEVIDADE REGISTRADA + 1 dia)</p>
          <div class="clock-display" id="tvtDisplay">
            <span id="tvtYears">00</span>a <span id="tvtMonths">00</span>m <span id="tvtDays">00</span>d <span id="tvtHours">00</span>h <span id="tvtMinutes">00</span>m <span id="tvtSeconds">00</span>s <span id="tvtMilliseconds">000</span>ms
          </div>
          <p class="small-text">Este √© o valor de refer√™ncia do TVT.</p>
        </div>
      </div>

      <div id="tvdt-content" class="tab-content hidden">
        <h2>TVDT (Tempo de Vida Destinado √†s Telas)
          <div class="info-icon-container">
            <span class="info-icon">‚ÑπÔ∏è</span>
            <div class="info-popup">
              O TVDT √© o Tempo de Vida Destinado √†s Telas, calculado com base no tempo que voc√™ passa logado no site, multiplicado por dois. Valorize seu tempo!
            </div>
          </div>
        </h2>
        <p>Acompanhe o tempo que voc√™ dedica √†s telas, valorizando cada segundo!</p>
        <div class="time-section">
          <h3>Seu Tempo Logado no Site</h3>
          <p class="small-text">Este √© o tempo acumulado que voc√™ permaneceu logado neste site.</p>
          <div class="clock-display" id="totalLoggedTimeDisplay">
            <span id="loggedHours">00</span>h <span id="loggedMinutes">00</span>m <span id="loggedSeconds">00</span>s <span id="loggedMilliseconds">000</span>ms
          </div>
        </div>

        <div class="time-section">
          <h3>TVDT Calculado (Tempo Logado x 2)</h3>
          <p class="small-text">F√≥rmula: (Seu Tempo Logado no Site x 2)</p>
          <div class="clock-display" id="tvdtCalculatedDisplay">
            <span id="tvdtHours">00</span>h <span id="tvdtMinutes">00</span>m <span id="tvdtSeconds">00</span>s <span id="tvdtMilliseconds">000</span>ms
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer>
    <p>&copy; 2025 Evoluzion. Todos os direitos reservados.</p>
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { 
      getAuth, 
      signOut, 
      onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { 
      getFirestore, 
      doc, 
      getDoc, 
      updateDoc 
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDUOF7BZIBNfJBXVmT2MGMMF6EBnUfsesk", // Use sua chave real
      authDomain: "evoluzion-id1.firebaseapp.com",
      projectId: "evoluzion-id1",
      storageBucket: "evoluzion-id1.appspot.com",
      messagingSenderId: "413091065593",
      appId: "1:413091065593:web:3527d66e02a2bf2f767c28"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM Elements - Perfil
    const statusText = document.getElementById("status");
    const nameInput = document.getElementById("nameInput");
    const emailInput = document.getElementById("emailInput");
    const dateOfBirthInput = document.getElementById("dateOfBirthInput");
    const placeOfBirthInput = document.getElementById("placeOfBirthInput");
    const saveProfileButton = document.getElementById("saveProfileButton");
    const logoutButton = document.getElementById("logoutButton");
    const headerProfileIcon = document.getElementById("headerProfileIcon");

    // DOM Elements - Abas
    const tabButtons = document.querySelectorAll(".tab-button");
    const tabContents = document.querySelectorAll(".tab-content");

    // DOM Elements - Homenagem Jeanne Calment (no TVV)
    const calmentYearsSpan = document.getElementById("calmentYears");
    const calmentMonthsSpan = document.getElementById("calmentMonths");
    const calmentDaysSpan = document.getElementById("calmentDays");
    const calmentTotalYearsSpan = document.getElementById("calmentTotalYears");
    const calmentTotalMonthsSpan = document.getElementById("calmentTotalMonths");
    const calmentTotalDaysSpan = document.getElementById("calmentTotalDays");

    // DOM Elements - Seu Tempo de Vida (no TVV)
    const myLifeCounterSection = document.getElementById("myLifeCounterSection");
    const myLifeYearsSpan = document.getElementById("myLifeYears");
    const myLifeMonthsSpan = document.getElementById("myLifeMonths");
    const myLifeDaysSpan = document.getElementById("myLifeDays");
    const myLifeHoursSpan = document.getElementById("myLifeHours");
    const myLifeMinutesSpan = document.getElementById("myLifeMinutes");
    const myLifeSecondsSpan = document.getElementById("myLifeSeconds");
    const myLifeMillisecondsSpan = document.getElementById("myLifeMilliseconds");
    const myLifeTotalYearsSpan = document.getElementById("myLifeTotalYears");
    const myLifeTotalMonthsSpan = document.getElementById("myLifeTotalMonths");
    const myLifeTotalDaysSpan = document.getElementById("myLifeTotalDays");


    // DOM Elements - TVT
    const tvtDisplay = document.getElementById("tvtDisplay");
    const tvtYearsSpan = document.getElementById("tvtYears");
    const tvtMonthsSpan = document.getElementById("tvtMonths");
    const tvtDaysSpan = document.getElementById("tvtDays");
    const tvtHoursSpan = document.getElementById("tvtHours");
    const tvtMinutesSpan = document.getElementById("tvtMinutes");
    const tvtSecondsSpan = document.getElementById("tvtSeconds");
    const tvtMillisecondsSpan = document.getElementById("tvtMilliseconds");


    // DOM Elements - TVDT
    const totalLoggedTimeDisplay = document.getElementById("totalLoggedTimeDisplay");
    const loggedHoursSpan = document.getElementById("loggedHours");
    const loggedMinutesSpan = document.getElementById("loggedMinutes");
    const loggedSecondsSpan = document.getElementById("loggedSeconds");
    const loggedMillisecondsSpan = document.getElementById("loggedMilliseconds");

    const tvdtCalculatedDisplay = document.getElementById("tvdtCalculatedDisplay");
    const tvdtHoursSpan = document.getElementById("tvdtHours");
    const tvdtMinutesSpan = document.getElementById("tvdtMinutes");
    const tvdtSecondsSpan = document.getElementById("tvdtSeconds");
    const tvdtMillisecondsSpan = document.getElementById("tvdtMilliseconds");


    let userBirthDate = null; // Armazena a data de nascimento do usu√°rio para o contador de vida
    let pageLoadTime = 0; // Hora que a p√°gina foi carregada para c√°lculo de sess√£o atual
    let accumulatedDigitalScreenTimeMs = 0; // Tempo total acumulado de uso do site
    let userHasLoggedInOnce = false; // Flag para a primeira vez que o usu√°rio loga e preenche dados


    // --- Fun√ß√µes de Utilit√°rio de Data e Tempo ---

    // Adiciona padding zero √† esquerda
    function pad(num, length = 2) {
      return num.toString().padStart(length, '0');
    }

    // Calcula diferen√ßa entre duas datas em anos, meses e dias exatos
    function getExactAge(birthDate, endDate) {
      const start = new Date(birthDate.getTime());
      const end = new Date(endDate.getTime());

      let years = end.getFullYear() - start.getFullYear();
      let months = end.getMonth() - start.getMonth();
      let days = end.getDate() - start.getDate();

      if (days < 0) {
        months--;
        days += new Date(end.getFullYear(), end.getMonth(), 0).getDate();
      }
      if (months < 0) {
        years--;
        months += 12;
      }
      return { years, months, days };
    }

    // Calcula total de dias, meses e anos
    function getTotalDuration(startDate, endDate) {
        const start = new Date(startDate);
        const end = new Date(endDate);

        const diffTime = Math.abs(end - start); // Diferen√ßa em milissegundos
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)); // Usar floor para total de dias completos
        
        // Para total de meses e anos, podemos usar a mesma l√≥gica de getExactAge mas sem negativar
        // Ou uma estimativa baseada em dias m√©dios, mas para "total de" a forma abaixo √© mais comum:
        const totalYears = end.getFullYear() - start.getFullYear() - (end < new Date(end.getFullYear(), start.getMonth(), start.getDate()) ? 1 : 0);
        const totalMonths = totalYears * 12 + (end.getMonth() - start.getMonth()) - (end.getDate() < start.getDate() ? 1 : 0);
        
        return { totalYears, totalMonths, totalDays: diffDays };
    }

    // Converte milissegundos para formato H:M:S.MS
    function formatMillisecondsToHMS(ms) {
      const totalSeconds = Math.floor(ms / 1000);
      const totalMinutes = Math.floor(totalSeconds / 60);
      const totalHours = Math.floor(totalMinutes / 60);

      const hours = totalHours;
      const minutes = totalMinutes % 60;
      const seconds = totalSeconds % 60;
      const milliseconds = ms % 1000;

      return {
        hours: hours,
        minutes: minutes,
        seconds: seconds,
        milliseconds: milliseconds
      };
    }

    // Converte milissegundos para formato A:M:D H:M:S.MS
    function formatMillisecondsToFullAge(ms) {
      // Implementa√ß√£o para obter anos, meses, dias a partir de milissegundos
      // √â mais preciso usar o c√°lculo de diferen√ßa de datas para anos/meses/dias
      // e ent√£o o restante em horas/minutos/segundos/ms.
      // Para o TVV do usu√°rio, j√° temos 'userBirthDate', ent√£o vamos usar getExactAge para A/M/D
      // e o restante do tempo para H/M/S/MS do dia atual.
      // Esta fun√ß√£o ser√° para o TVT/TVDT que s√£o apenas dura√ß√µes em MS.

      const days = Math.floor(ms / (1000 * 60 * 60 * 24));
      let remainingMs = ms % (1000 * 60 * 60 * 24);

      const hours = Math.floor(remainingMs / (1000 * 60 * 60));
      remainingMs %= (1000 * 60 * 60);

      const minutes = Math.floor(remainingMs / (1000 * 60));
      remainingMs %= (1000 * 60);

      const seconds = Math.floor(remainingMs / 1000);
      const milliseconds = Math.floor(remainingMs % 1000);

      return { days, hours, minutes, seconds, milliseconds };
    }


    // --- Homenagem a Jeanne Calment (no TVV) ---
    // Datas de Jeanne Calment (GMT/UTC para consist√™ncia)
    const calmentBirthDate = new Date(Date.UTC(1875, 1, 21, 0, 0, 0)); // M√™s √© 0-indexado, ent√£o 1 √© fevereiro
    const calmentDeathDate = new Date(Date.UTC(1997, 7, 4, 0, 0, 0)); // M√™s √© 0-indexado, ent√£o 7 √© agosto

    function displayCalmentTribute() {
      const age = getExactAge(calmentBirthDate, calmentDeathDate);
      calmentYearsSpan.textContent = age.years;
      calmentMonthsSpan.textContent = age.months;
      calmentDaysSpan.textContent = age.days;

      const totalDuration = getTotalDuration(calmentBirthDate, calmentDeathDate);
      calmentTotalYearsSpan.textContent = totalDuration.totalYears;
      calmentTotalMonthsSpan.textContent = totalDuration.totalMonths;
      calmentTotalDaysSpan.textContent = totalDuration.totalDays;
    }

    // --- Seu Tempo de Vida (no TVV) ---
    let myLifeInterval;
    function updateMyLifeClock() {
      if (!userBirthDate) {
        myLifeCounterSection.style.display = 'none';
        return;
      } else {
        myLifeCounterSection.style.display = 'block';
      }

      const now = new Date();
      const diffMilliseconds = now - userBirthDate;

      if (diffMilliseconds < 0) {
        myLifeClock.textContent = "Data de nascimento futura!";
        myLifeTotalValues.textContent = "";
        return;
      }

      const ageExact = getExactAge(userBirthDate, now);
      myLifeYearsSpan.textContent = pad(ageExact.years);
      myLifeMonthsSpan.textContent = pad(ageExact.months);
      myLifeDaysSpan.textContent = pad(ageExact.days);

      // Calcula horas, minutos, segundos, milissegundos restantes do dia atual
      let remainingMilliseconds = diffMilliseconds % (1000 * 60 * 60 * 24);

      const hours = Math.floor(remainingMilliseconds / (1000 * 60 * 60));
      remainingMilliseconds %= (1000 * 60 * 60);

      const minutes = Math.floor(remainingMilliseconds / (1000 * 60));
      remainingMilliseconds %= (1000 * 60);

      const seconds = Math.floor(remainingMilliseconds / 1000);
      const milliseconds = Math.floor(remainingMilliseconds % 1000);

      myLifeHoursSpan.textContent = pad(hours);
      myLifeMinutesSpan.textContent = pad(minutes);
      myLifeSecondsSpan.textContent = pad(seconds);
      myLifeMillisecondsSpan.textContent = pad(milliseconds, 3);

      const totalDuration = getTotalDuration(userBirthDate, now);
      myLifeTotalYearsSpan.textContent = totalDuration.totalYears;
      myLifeTotalMonthsSpan.textContent = totalDuration.totalMonths;
      myLifeTotalDaysSpan.textContent = totalDuration.totalDays;
    }

    // --- TVT (Tempo de Vida Token) ---
    let tvtInterval;
    function calculateAndDisplayTVT() {
      const calmentLifespanMs = calmentDeathDate.getTime() - calmentBirthDate.getTime();
      const oneDayMs = 24 * 60 * 60 * 1000;
      const tvtMs = calmentLifespanMs + oneDayMs;

      const duration = formatMillisecondsToFullAge(tvtMs);

      tvtYearsSpan.textContent = getExactAge(calmentBirthDate, new Date(calmentDeathDate.getTime() + oneDayMs)).years;
      tvtMonthsSpan.textContent = getExactAge(calmentBirthDate, new Date(calmentDeathDate.getTime() + oneDayMs)).months;
      tvtDaysSpan.textContent = getExactAge(calmentBirthDate, new Date(calmentDeathDate.getTime() + oneDayMs)).days;
      tvtHoursSpan.textContent = pad(duration.hours);
      tvtMinutesSpan.textContent = pad(duration.minutes);
      tvtSecondsSpan.textContent = pad(duration.seconds);
      tvtMillisecondsSpan.textContent = pad(duration.milliseconds, 3);
    }

    // --- TVDT (Tempo de Vida Destinado √†s Telas) ---
    let tvdtInterval;
    let currentSessionStartTime = 0; // Marca o in√≠cio da sess√£o atual na aba
    let currentLoggedTimeMs = 0; // Tempo logado na sess√£o atual
    
    // Fun√ß√µes para lidar com o tempo de tela
    function startScreenTimeTracking() {
        if (currentLoggedTimeMs === 0) { // Primeira vez na sess√£o ou reentrada
            currentSessionStartTime = Date.now();
        }
        if (!tvdtInterval) {
            tvdtInterval = setInterval(() => {
                if (!document.hidden) { // Apenas conta se a aba est√° vis√≠vel
                    const now = Date.now();
                    const elapsed = now - currentSessionStartTime;
                    currentLoggedTimeMs += elapsed;
                    currentSessionStartTime = now; // Reinicia para a pr√≥xima contagem

                    displayTVDTData();
                }
            }, 100); // Atualiza a cada 100ms para menor carga, milissegundos ainda vis√≠veis
        }
    }

    function stopScreenTimeTracking() {
        if (tvdtInterval) {
            clearInterval(tvdtInterval);
            tvdtInterval = null;
        }
        // Ao parar, adiciona o tempo da sess√£o atual ao total acumulado
        accumulatedDigitalScreenTimeMs += currentLoggedTimeMs;
        currentLoggedTimeMs = 0; // Reseta para a sess√£o atual
        
        // Salva no Firestore
        const user = auth.currentUser;
        if (user) {
            updateDoc(doc(db, "users", user.uid), {
                accumulatedDigitalScreenTimeMs: accumulatedDigitalScreenTimeMs
            }).catch(error => {
                console.error("Erro ao salvar tempo de tela:", error);
            });
        }
    }

    // Exibe os dados do TVDT
    function displayTVDTData() {
        // Tempo Total Logado (acumulado de sess√µes anteriores + sess√£o atual)
        const totalCurrentLoggedMs = accumulatedDigitalScreenTimeMs + currentLoggedTimeMs;
        const loggedFormatted = formatMillisecondsToHMS(totalCurrentLoggedMs);
        loggedHoursSpan.textContent = pad(loggedFormatted.hours);
        loggedMinutesSpan.textContent = pad(loggedFormatted.minutes);
        loggedSecondsSpan.textContent = pad(loggedFormatted.seconds);
        loggedMillisecondsSpan.textContent = pad(loggedFormatted.milliseconds, 3);

        // TVDT Calculado (Tempo Total Logado x 2)
        const tvdtCalculatedMs = totalCurrentLoggedMs * 2;
        const tvdtFormatted = formatMillisecondsToHMS(tvdtCalculatedMs);
        tvdtHoursSpan.textContent = pad(tvdtFormatted.hours);
        tvdtMinutesSpan.textContent = pad(tvdtFormatted.minutes);
        tvdtSecondsSpan.textContent = pad(tvdtFormatted.seconds);
        tvdtMillisecondsSpan.textContent = pad(tvdtFormatted.milliseconds, 3);
    }


    // --- Listener de Autentica√ß√£o ---
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        emailInput.value = user.email || "N√£o dispon√≠vel";
        await loadUserProfile(user.uid);
        
        // Define a aba 'TVV' como ativa por padr√£o se o usu√°rio j√° preencheu dados
        if (userHasLoggedInOnce) {
          document.querySelector('.tab-button[data-tab="tvv"]').click();
        } else {
          // Se for a primeira vez, mant√©m no perfil para preencher
          document.querySelector('.tab-button[data-tab="profile"]').click();
        }
      } else {
        window.location.href = "./index.html";
      }
    });

    // --- Carregar Dados do Perfil ---
    async function loadUserProfile(uid) {
      statusText.className = "status-message";
      statusText.innerText = "Carregando perfil...";
      try {
        const userRef = doc(db, "users", uid);
        const userSnap = await getDoc(userRef);

        if (userSnap.exists()) {
          const currentUserData = userSnap.data();
          nameInput.value = currentUserData.name || "";
          placeOfBirthInput.value = currentUserData.placeOfBirth || "";

          if (currentUserData.dateOfBirth && typeof currentUserData.dateOfBirth.toDate === 'function') {
            userBirthDate = currentUserData.dateOfBirth.toDate();
            dateOfBirthInput.value = userBirthDate.toISOString().split('T')[0];
          } else {
            dateOfBirthInput.value = "";
            userBirthDate = null;
          }
          
          accumulatedDigitalScreenTimeMs = currentUserData.accumulatedDigitalScreenTimeMs || 0;

          // Se o nome e a data de nascimento j√° foram preenchidos, consideramos que o usu√°rio j√° "preencheu os dados"
          if (currentUserData.name && currentUserData.dateOfBirth) {
            userHasLoggedInOnce = true;
          } else {
            userHasLoggedInOnce = false;
          }

          statusText.innerText = "";
        } else {
          statusText.innerText = "Documento de perfil n√£o encontrado. Crie um novo.";
          userBirthDate = null;
          accumulatedDigitalScreenTimeMs = 0;
          userHasLoggedInOnce = false;
        }
      } catch (error) {
        console.error("Erro ao carregar perfil:", error);
        statusText.innerText = `Erro ao carregar perfil: ${error.message}`;
        userBirthDate = null;
        accumulatedDigitalScreenTimeMs = 0;
        userHasLoggedInOnce = false;
      }
    }

    // --- Salvar Dados do Perfil ---
    saveProfileButton.addEventListener("click", async () => {
      const user = auth.currentUser;
      if (!user) {
        statusText.innerText = "Nenhum usu√°rio logado para salvar.";
        return;
      }

      statusText.className = "status-message";
      statusText.innerText = "Salvando perfil...";
      
      const updatedName = nameInput.value.trim();
      const updatedPlaceOfBirth = placeOfBirthInput.value.trim();
      const dobString = dateOfBirthInput.value;

      let updatedDateOfBirth = null;
      if (dobString) {
        try {
          // Garante que a data seja salva como UTC meia-noite para consist√™ncia
          updatedDateOfBirth = new Date(dobString + "T00:00:00Z"); 
          if (isNaN(updatedDateOfBirth.getTime())) {
            throw new Error("Data de nascimento inv√°lida.");
          }
        } catch (error) {
          statusText.innerText = `Erro na data de nascimento: ${error.message}`;
          return;
        }
      }

      try {
        const userRef = doc(db, "users", user.uid);
        await updateDoc(userRef, {
          name: updatedName,
          dateOfBirth: updatedDateOfBirth,
          placeOfBirth: updatedPlaceOfBirth
        }, { merge: true }); // Usar merge para n√£o sobrescrever outros campos

        userBirthDate = updatedDateOfBirth; // Atualiza a vari√°vel local
        
        // Verifica se os dados essenciais foram preenchidos para setar userHasLoggedInOnce
        if (updatedName && updatedDateOfBirth) {
            userHasLoggedInOnce = true;
        }

        statusText.innerText = "Perfil salvo com sucesso!";
        statusText.className = "status-message success-message";
      } catch (error) {
        console.error("Erro ao salvar perfil:", error);
        statusText.innerText = `Erro ao salvar perfil: ${error.message}`;
      }
    });

    // --- Sair (Logout) ---
    logoutButton.addEventListener("click", async () => {
      stopScreenTimeTracking(); // Salva o tempo de tela antes de sair
      try {
        await signOut(auth);
        window.location.href = "./index.html";
      } catch (error) {
        console.error("Erro ao sair:", error);
        statusText.innerText = `Erro ao sair: ${error.message}`;
      }
    });

    // --- L√≥gica das Abas ---
    tabButtons.forEach(button => {
      button.addEventListener("click", () => {
        const targetTab = button.dataset.tab;

        tabButtons.forEach(btn => btn.classList.remove("active"));
        tabContents.forEach(content => content.classList.add("hidden"));

        button.classList.add("active");
        document.getElementById(`${targetTab}-content`).classList.remove("hidden");

        // Gerencia os intervalos dos rel√≥gios
        if (myLifeInterval) clearInterval(myLifeInterval);
        if (tvtInterval) clearInterval(tvtInterval);
        if (tvdtInterval) clearInterval(tvdtInterval);
        stopScreenTimeTracking(); // Para e salva o tempo de tela ao trocar de aba

        if (targetTab === 'tvv') {
          updateMyLifeClock(); // Chama uma vez para inicializar
          myLifeInterval = setInterval(updateMyLifeClock, 10);
        } else if (targetTab === 'tvt') {
          calculateAndDisplayTVT(); // Calcula e exibe TVT
          // TVT n√£o √© um rel√≥gio vivo em milissegundos no sentido de tempo decorrido, mas uma dura√ß√£o fixa
          // Se quiser que ele "pisque" milissegundos, podemos simular:
          tvtInterval = setInterval(calculateAndDisplayTVT, 10); // Para simular um "rel√≥gio" em ms
        } else if (targetTab === 'tvdt') {
            startScreenTimeTracking(); // Inicia o rastreamento do tempo de tela
            displayTVDTData(); // Exibe os dados iniciais
        }
      });
    });

    // --- √çcone de Perfil no Header ---
    headerProfileIcon.addEventListener("click", () => {
        document.querySelector('.tab-button[data-tab="profile"]').click();
    });

    // --- Inicializa√ß√£o ao Carregar a P√°gina ---
    document.addEventListener("DOMContentLoaded", () => {
      displayCalmentTribute(); // Exibe a homenagem a Jeanne Calment
      
      // O onAuthStateChanged vai decidir qual aba abrir inicialmente
      // E ele carrega os dados do perfil, incluindo accumulatedDigitalScreenTimeMs
    });

    // --- Salvar tempo de tela acumulado ao fechar/navegar na p√°gina ---
    window.addEventListener('beforeunload', () => {
        stopScreenTimeTracking(); // Garante que o tempo da sess√£o atual seja salvo
    });

  </script>
</body>
</html>
