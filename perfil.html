<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Perfil ID1 | Carteira e Ampulheta Digital</title>
  <style>
    /* Reset b√°sico e estilos gerais */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background: #eef1f6;
      color: #333;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      align-items: center;
    }
    .container {
      max-width: 960px;
      width: 100%;
      padding: 20px;
      box-sizing: border-box;
    }
    h1, h2, h3 {
      color: #2c3e50;
      text-align: center;
      margin-bottom: 20px;
    }
    .card {
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      padding: 30px;
      margin-bottom: 25px;
    }
    .grid-2-cols {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
    }
    @media (min-width: 768px) {
      .grid-2-cols {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    .button {
      background: #4a90e2;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.3s ease;
      display: inline-block;
      margin-top: 10px;
      margin-right: 5px; /* Para bot√µes lado a lado */
    }
    .button:hover {
      background-color: #357bd8;
    }
    .button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .danger-button {
      background: #e74c3c;
    }
    .danger-button:hover {
      background-color: #c0392b;
    }
    .secondary-button {
        background: #6c757d;
    }
    .secondary-button:hover {
        background: #5a6268;
    }
    input[type="date"],
    input[type="number"],
    input[type="file"],
    input[type="text"],
    select {
      width: calc(100% - 22px);
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #555;
      text-align: left;
    }
    .document-list ul {
      list-style: none;
      padding: 0;
    }
    .document-list li {
      background: #f9f9f9;
      border: 1px solid #eee;
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .document-list li a {
      color: #4a90e2;
      text-decoration: none;
      word-break: break-all;
    }
    .document-list li a:hover {
      text-decoration: underline;
    }
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border-left-color: #4a90e2;
      animation: spin 1s ease infinite;
      display: inline-block;
      vertical-align: middle;
      margin-left: 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    #loadingMessage, #errorMessage {
      text-align: center;
      padding: 20px;
      font-size: 1.1rem;
      color: #555;
    }
    #errorMessage {
      color: #e74c3c;
      font-weight: bold;
    }
    #profileContent {
      display: none; /* Esconde at√© o usu√°rio ser carregado */
    }
    .modal {
      display: none; /* Hidden by default */
      position: fixed; /* Stay in place */
      z-index: 1000; /* Sit on top */
      left: 0;
      top: 0;
      width: 100%; /* Full width */
      height: 100%; /* Full height */
      overflow: auto; /* Enable scroll if needed */
      background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background-color: #fefefe;
      margin: auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%; /* Could be more responsive */
      max-width: 500px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      text-align: center;
    }
    .modal-content h3 {
        margin-top: 0;
    }
    .modal-content input {
        margin-bottom: 15px;
    }
    .stat-item {
        background: #f8fbfd;
        padding: 15px;
        border-radius: 5px;
        border: 1px solid #e0e6ed;
        margin-bottom: 10px;
    }
    .stat-item strong {
        display: block;
        font-size: 1.2em;
        color: #2c3e50;
        margin-bottom: 5px;
    }
    .stat-item span {
        font-size: 0.9em;
        color: #7f8c8d;
    }
    #documentTypeSelect {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
    }
    /* Estilos para o modo de edi√ß√£o de perfil */
    .profile-display-mode { display: block; }
    .profile-edit-mode { display: none; }
    .profile-display-mode p, .profile-display-mode button { margin-bottom: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="header-title">üåü Perfil ID1 | Sua Identidade Digital</h1>

    <p id="loadingMessage">Carregando dados do perfil... <span class="spinner"></span></p>
    <p id="errorMessage" style="display: none;"></p>

    <div id="profileContent">
      <div class="grid-2-cols">
        <div class="card">
          <h2>Dados do Perfil</h2>

          <div id="profileDisplayMode" class="profile-display-mode">
            <p><strong>Nome:</strong> <span id="userName"></span></p>
            <p><strong>E-mail:</strong> <span id="userEmail"></span></p>
            <p><strong>M√©todo de Login:</strong> <span id="userLoginMethod"></span></p>
            <p><strong>Membro desde:</strong> <span id="memberSince"></span></p>
            <p><strong>Data de Nascimento:</strong> <span id="userDobDisplay"></span></p>
            <p><strong>Local de Nascimento:</strong> <span id="userPobDisplay"></span></p>
            <button id="editProfileBtn" class="button">Editar Perfil</button>
            <button id="logoutBtn" class="button danger-button">Sair</button>
          </div>

          <div id="profileEditMode" class="profile-edit-mode">
            <label for="editNameInput">Nome:</label>
            <input type="text" id="editNameInput" placeholder="Seu nome completo">

            <label for="editDobInput">Data de Nascimento:</label>
            <input type="date" id="editDobInput">

            <label for="editPobInput">Local de Nascimento:</label>
            <input type="text" id="editPobInput" placeholder="Cidade, Pa√≠s">

            <button id="saveProfileBtn" class="button">Salvar Altera√ß√µes</button>
            <button id="cancelEditBtn" class="button secondary-button">Cancelar</button>
            <p id="editProfileStatus" style="font-size: 0.9em; color: #7f8c8d; margin-top: 5px;"></p>
          </div>
        </div>

        <div class="card">
          <h2>Ampulheta Digital</h2>
          <div class="stat-item">
            <strong><span id="daysLivedDisplay">0</span> dias</strong>
            <span>Voc√™ j√° viveu</span>
          </div>
          <div class="stat-item">
            <strong>TVT Atribu√≠do: <span id="tvtTotalAttributedDisplay">0</span> dias</strong>
            <span>Tempo de Vida Total (Base + Vivido + B√¥nus)</span>
          </div>
          <div class="stat-item">
            <strong>TVDT Bruto: <span id="tvdtRawScreenTimeDisplay">0</span> horas</strong>
            <span>Tempo de Vida Dedicado a Telas (horas)</span>
          </div>
          <div class="stat-item">
            <strong>TVDT Token: <span id="tvdtTokenValueDisplay">0</span></strong>
            <span>(Tempo de Tela x 2)</span>
          </div>

          <h3>Registrar Tempo de Tela</h3>
          <label for="screenTimeInput">Horas Di√°rias nas Telas:</label>
          <input type="number" id="screenTimeInput" min="0" max="24" step="0.1" placeholder="Ex: 5.5">
          <button id="recordScreenTimeBtn" class="button">Registrar Tempo</button>
          <p id="screenTimeStatus" style="font-size: 0.9em; color: #7f8c8d; margin-top: 5px;"></p>
        </div>
      </div>

      <div class="grid-2-cols">
        <div class="card">
          <h2>Carteira de Documentos</h2>
          <p>Guarde c√≥pias dos seus documentos com seguran√ßa.</p>
          <label for="documentTypeSelect">Tipo de Documento:</label>
          <select id="documentTypeSelect">
            <option value="">Selecione...</option>
            <option value="CNH">CNH</option>
            <option value="RG">RG</option>
            <option value="CPF">CPF</option>
            <option value="Comprovante de Residencia">Comprovante de Resid√™ncia</option>
            <option value="Outros">Outros</option>
          </select>
          <label for="documentUploadInput">Selecionar Arquivo:</label>
          <input type="file" id="documentUploadInput" accept="image/*,.pdf">
          <button id="uploadDocumentBtn" class="button">Fazer Upload</button>
          <p id="uploadStatus" style="font-size: 0.9em; color: #7f8c8d; margin-top: 5px;"></p>

          <h3>Meus Documentos</h3>
          <div class="document-list">
            <ul id="uploadedDocumentsList">
              <li>Nenhum documento enviado ainda.</li>
            </ul>
          </div>
        </div>

        <div class="card">
          <h2>Provas e Renda Universal</h2>
          <p>Realize as provas para acessar a Renda Universal.</p>
          <p>Seu "mais valor" √© adicionado a cada Prova de Vida.</p>

          <h3>Prova de Vida</h3>
          <button id="proofOfLifeBtn" class="button">Realizar Prova de Vida</button>
          <p id="proofOfLifeStatus" style="font-size: 0.9em; color: #7f8c8d; margin-top: 5px;"></p>
          
          </div>
      </div>
    </div>
  </div>

  <div id="dobModal" class="modal">
    <div class="modal-content">
      <h3>Por favor, insira sua data de nascimento</h3>
      <p>Precisamos desta informa√ß√£o para calcular seu Tempo de Vida Total (TVT).</p>
      <label for="dobInput">Data de Nascimento:</label>
      <input type="date" id="dobInput">
      <button id="saveDobBtn" class="button">Salvar Data de Nascimento</button>
      <p id="dobStatus" style="font-size: 0.9em; color: #e74c3c; margin-top: 5px;"></p>
    </div>
  </div>

  <script type="module">
    // Importa√ß√µes do Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

    // Sua configura√ß√£o do Firebase (Mesma do index.html)
    // EM PRODU√á√ÉO, USE VARI√ÅVEIS DE AMBIENTE PARA A CHAVE API E OUTROS DADOS SENS√çVEIS!
    const firebaseConfig = {
      apiKey: "AIzaSyDUOF7BZIBNfJBXVmT2MGMMF6EBnUfsesk",
      authDomain: "evoluzion-id1.firebaseapp.com",
      projectId: "evoluzion-id1",
      storageBucket: "evoluzion-id1.appspot.com",
      messagingSenderId: "413091065593",
      appId: "1:413091065593:web:3527d66e02a2bf2f767c28"
    };

    // Inicializa o Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // --- Constantes Globais ---
    const TVT_BASE_DAYS = 44724; // Jeanne Calment: 122 anos e 164 dias
    const MS_PER_DAY = 1000 * 60 * 60 * 24;

    // --- Elementos DOM ---
    // Display Mode
    const userNameElem = document.getElementById("userName");
    const userEmailElem = document.getElementById("userEmail");
    const userLoginMethodElem = document.getElementById("userLoginMethod"); // NOVO
    const memberSinceElem = document.getElementById("memberSince");
    const userDobDisplay = document.getElementById("userDobDisplay"); // NOVO
    const userPobDisplay = document.getElementById("userPobDisplay"); // NOVO
    const editProfileBtn = document.getElementById("editProfileBtn"); // NOVO
    const logoutBtn = document.getElementById("logoutBtn");

    // Edit Mode
    const profileDisplayMode = document.getElementById("profileDisplayMode"); // NOVO
    const profileEditMode = document.getElementById("profileEditMode");     // NOVO
    const editNameInput = document.getElementById("editNameInput");       // NOVO
    const editDobInput = document.getElementById("editDobInput");         // NOVO
    const editPobInput = document.getElementById("editPobInput");         // NOVO
    const saveProfileBtn = document.getElementById("saveProfileBtn");     // NOVO
    const cancelEditBtn = document.getElementById("cancelEditBtn");       // NOVO
    const editProfileStatus = document.getElementById("editProfileStatus"); // NOVO

    const loadingMessage = document.getElementById("loadingMessage");
    const errorMessage = document.getElementById("errorMessage");
    const profileContent = document.getElementById("profileContent");

    // Ampulheta Digital
    const daysLivedDisplay = document.getElementById("daysLivedDisplay");
    const tvtTotalAttributedDisplay = document.getElementById("tvtTotalAttributedDisplay");
    const tvdtRawScreenTimeDisplay = document.getElementById("tvdtRawScreenTimeDisplay");
    const tvdtTokenValueDisplay = document.getElementById("tvdtTokenValueDisplay");
    const screenTimeInput = document.getElementById("screenTimeInput");
    const recordScreenTimeBtn = document.getElementById("recordScreenTimeBtn");
    const screenTimeStatus = document.getElementById("screenTimeStatus");

    // Carteira de Documentos
    const documentTypeSelect = document.getElementById("documentTypeSelect");
    const documentUploadInput = document.getElementById("documentUploadInput");
    const uploadDocumentBtn = document.getElementById("uploadDocumentBtn");
    const uploadStatus = document.getElementById("uploadStatus");
    const uploadedDocumentsList = document.getElementById("uploadedDocumentsList");

    // Provas
    const proofOfLifeBtn = document.getElementById("proofOfLifeBtn");
    const proofOfLifeStatus = document.getElementById("proofOfLifeStatus");

    // Modal Data de Nascimento (ainda existe para o primeiro preenchimento obrigat√≥rio)
    const dobModal = document.getElementById("dobModal");
    const dobInput = document.getElementById("dobInput");
    const saveDobBtn = document.getElementById("saveDobBtn");
    const dobStatus = document.getElementById("dobStatus");

    let currentUserData = null; // Vari√°vel para armazenar os dados do usu√°rio logado do Firestore

    // --- Fun√ß√µes de Utilidade ---

    // Exibir mensagem de erro na p√°gina principal
    function showPageErrorMessage(message) {
      loadingMessage.style.display = 'none';
      profileContent.style.display = 'none';
      errorMessage.innerText = message;
      errorMessage.style.display = 'block';
    }

    // Calcular dias vividos
    function calculateDaysLived(dateOfBirth) {
        if (!dateOfBirth) return 0;
        const birthDate = dateOfBirth instanceof Date ? birthDate : new Date(dateOfBirth);
        const today = new Date();
        const diffTime = Math.abs(today.getTime() - birthDate.getTime());
        return Math.ceil(diffTime / MS_PER_DAY);
    }

    // Formatar segundos em HH:MM:SS
    function formatSeconds(totalSeconds) {
        if (totalSeconds < 0) totalSeconds = 0;
        const hours = Math.floor(totalSeconds / 3600);
        totalSeconds %= 3600;
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = Math.floor(totalSeconds % 60);
        return `${hours}h ${minutes}m ${seconds}s`;
    }

    // Obter o m√©todo de login
    function getLoginMethod(user) {
        if (user.isAnonymous) return "An√¥nimo";
        if (user.providerData && user.providerData.length > 0) {
            const providerIds = user.providerData.map(p => p.providerId);
            if (providerIds.includes("google.com")) return "Google";
            if (providerIds.includes("password")) return "E-mail/Senha";
            if (providerIds.includes("phone")) return "Smartphone";
        }
        return "Desconhecido";
    }

    // --- Fun√ß√µes de Intera√ß√£o com Firebase ---

    // Fun√ß√£o para buscar e exibir dados do perfil e ampulheta digital
    async function loadUserProfile(user) {
        const userDocRef = doc(db, "users", user.uid);
        const userSnap = await getDoc(userDocRef);

        if (userSnap.exists()) {
            const userData = userSnap.data();
            currentUserData = userData; // Salva os dados do usu√°rio globalmente

            // Exibe dados no modo de visualiza√ß√£o
            userNameElem.innerText = userData.name || user.displayName || "N√£o informado";
            userEmailElem.innerText = userData.email || user.email || "N√£o informado";
            userLoginMethodElem.innerText = getLoginMethod(user);
            memberSinceElem.innerText = userData.createdAt ? new Date(userData.createdAt.toDate()).toLocaleDateString() : "N/A";
            userDobDisplay.innerText = userData.dateOfBirth ? new Date(userData.dateOfBirth.toDate()).toLocaleDateString() : "N√£o informado";
            userPobDisplay.innerText = userData.placeOfBirth || "N√£o informado";

            // Preenche inputs para o modo de edi√ß√£o
            editNameInput.value = userData.name || user.displayName || "";
            editDobInput.value = userData.dateOfBirth ? new Date(userData.dateOfBirth.toDate()).toISOString().split('T')[0] : "";
            editPobInput.value = userData.placeOfBirth || "";

            // --- Gerenciamento da Data de Nascimento no primeiro login/preenchimento ---
            if (!userData.dateOfBirth) {
                dobModal.style.display = 'flex'; // Exibe o modal para preencher a DOB
            } else {
                dobModal.style.display = 'none'; // Esconde o modal se j√° tiver
                updateDigitalHourglassDisplay(userData);
            }
            
            // Carregar e exibir documentos
            loadUserDocuments(user.uid);

        } else {
            showPageErrorMessage("Dados do usu√°rio n√£o encontrados. Por favor, tente novamente ou entre em contato com o suporte.");
        }
    }

    // Fun√ß√£o para atualizar a exibi√ß√£o da ampulheta digital
    function updateDigitalHourglassDisplay(userData) {
        const daysLived = userData.dateOfBirth ? calculateDaysLived(userData.dateOfBirth) : 0;
        const tvtBonusDays = userData.tvt_bonus_days || 0;
        const tvtTotalAttributed = TVT_BASE_DAYS + daysLived + tvtBonusDays;

        daysLivedDisplay.innerText = daysLived;
        tvtTotalAttributedDisplay.innerText = tvtTotalAttributed;
        
        // TVDT
        const tvdtRawScreenTimeSeconds = userData.tvdt_screen_time_seconds || 0;
        const tvdtTokenValueSeconds = tvdtRawScreenTimeSeconds * 2;

        tvdtRawScreenTimeDisplay.innerText = formatSeconds(tvdtRawScreenTimeSeconds);
        tvdtTokenValueDisplay.innerText = formatSeconds(tvdtTokenValueSeconds);
    }

    // --- Edi√ß√£o de Perfil ---
    editProfileBtn.addEventListener("click", () => {
        profileDisplayMode.style.display = 'none';
        profileEditMode.style.display = 'block';
        editProfileStatus.innerText = ""; // Limpa status anterior
    });

    cancelEditBtn.addEventListener("click", () => {
        profileDisplayMode.style.display = 'block';
        profileEditMode.style.display = 'none';
    });

    saveProfileBtn.addEventListener("click", async () => {
        if (!currentUserData || !auth.currentUser) {
            editProfileStatus.innerText = "Erro: Usu√°rio n√£o logado.";
            return;
        }

        const newName = editNameInput.value.trim();
        const newDob = editDobInput.value;
        const newPob = editPobInput.value.trim();

        editProfileBtn.disabled = true; // Desabilita bot√µes durante o salvamento
        saveProfileBtn.disabled = true;
        cancelEditBtn.disabled = true;
        editProfileStatus.innerText = "Salvando...";

        try {
            const userAuth = auth.currentUser;
            const userDocRef = doc(db, "users", userAuth.uid);

            const updates = {};
            let authProfileUpdateNeeded = false;

            // Atualiza nome no Firebase Auth (se mudou)
            if (newName !== (userAuth.displayName || currentUserData.name)) {
                await updateProfile(userAuth, { displayName: newName });
                updates.name = newName; // Tamb√©m salva no Firestore
                authProfileUpdateNeeded = true;
            } else {
                updates.name = currentUserData.name; // Garante que o nome atual seja salvo no Firestore
            }


            // Atualiza Data de Nascimento no Firestore
            if (newDob) {
                updates.dateOfBirth = new Date(newDob);
            } else {
                 // Se o campo for esvaziado, pode querer remover ou deixar como est√°
                 // updates.dateOfBirth = null; // Para remover
                 if (currentUserData.dateOfBirth) updates.dateOfBirth = currentUserData.dateOfBirth; // Mant√©m o anterior se vazio
            }

            // Atualiza Local de Nascimento no Firestore
            if (newPob) {
                updates.placeOfBirth = newPob;
            } else {
                // updates.placeOfBirth = null; // Para remover
                if (currentUserData.placeOfBirth) updates.placeOfBirth = currentUserData.placeOfBirth; // Mant√©m o anterior se vazio
            }
            
            await updateDoc(userDocRef, updates);
            
            // Atualiza currentUserData localmente com as novas informa√ß√µes para refletir imediatamente
            currentUserData = { ...currentUserData, ...updates };

            editProfileStatus.innerText = "Perfil atualizado com sucesso!";
            
            // Atualiza a exibi√ß√£o no modo de visualiza√ß√£o
            userNameElem.innerText = currentUserData.name || userAuth.displayName || "N√£o informado";
            userDobDisplay.innerText = currentUserData.dateOfBirth ? new Date(currentUserData.dateOfBirth.toDate()).toLocaleDateString() : "N√£o informado";
            userPobDisplay.innerText = currentUserData.placeOfBirth || "N√£o informado";
            
            // Se o nome foi atualizado no Auth, o displayName do objeto userAuth j√° estar√° atualizado
            if (authProfileUpdateNeeded) {
                userAuth.reload(); // Recarrega o objeto userAuth para garantir que displayname esteja atualizado
            }


            // Volta para o modo de visualiza√ß√£o
            setTimeout(() => {
                profileDisplayMode.style.display = 'block';
                profileEditMode.style.display = 'none';
                editProfileStatus.innerText = "";
            }, 1500); // D√° um tempo para o usu√°rio ver a mensagem de sucesso

        } catch (error) {
            console.error("Erro ao salvar perfil:", error);
            editProfileStatus.innerText = `Erro ao salvar perfil: ${error.message}`;
        } finally {
            editProfileBtn.disabled = false;
            saveProfileBtn.disabled = false;
            cancelEditBtn.disabled = false;
        }
    });


    // Fun√ß√£o para salvar a data de nascimento (do modal de primeiro preenchimento)
    saveDobBtn.addEventListener("click", async () => {
        const dob = dobInput.value;
        if (!dob) {
            dobStatus.innerText = "Por favor, selecione uma data.";
            return;
        }
        if (!currentUserData || !currentUserData.uid) {
            dobStatus.innerText = "Erro: Usu√°rio n√£o identificado. Recarregue a p√°gina.";
            return;
        }

        try {
            await updateDoc(doc(db, "users", currentUserData.uid), {
                dateOfBirth: new Date(dob) // Salva como timestamp do Firebase
            });
            currentUserData.dateOfBirth = new Date(dob); // Atualiza o objeto local
            updateDigitalHourglassDisplay(currentUserData);
            userDobDisplay.innerText = new Date(currentUserData.dateOfBirth.toDate()).toLocaleDateString(); // Atualiza a exibi√ß√£o
            dobModal.style.display = 'none';
            dobStatus.innerText = "";
        } catch (error) {
            console.error("Erro ao salvar data de nascimento:", error);
            dobStatus.innerText = "Erro ao salvar data. Tente novamente.";
        }
    });

    // Fun√ß√£o para registrar tempo de tela (continua igual)
    recordScreenTimeBtn.addEventListener("click", async () => {
        if (!currentUserData || !currentUserData.uid) {
            screenTimeStatus.innerText = "Erro: Usu√°rio n√£o logado.";
            return;
        }

        const screenTimeHours = parseFloat(screenTimeInput.value);
        if (isNaN(screenTimeHours) || screenTimeHours < 0 || screenTimeHours > 24) {
            screenTimeStatus.innerText = "Por favor, insira um n√∫mero v√°lido de horas (0-24).";
            return;
        }
        const screenTimeSeconds = screenTimeHours * 3600; // Converte horas para segundos

        recordScreenTimeBtn.disabled = true;
        screenTimeStatus.innerText = "Registrando...";

        try {
            const userDocRef = doc(db, "users", currentUserData.uid);
            // Incrementa o tempo de tela existente
            const currentScreenTimeSeconds = currentUserData.tvdt_screen_time_seconds || 0;
            const newScreenTimeSeconds = currentScreenTimeSeconds + screenTimeSeconds;

            await updateDoc(userDocRef, {
                tvdt_screen_time_seconds: newScreenTimeSeconds,
                last_tvdt_update: new Date()
            });

            currentUserData.tvdt_screen_time_seconds = newScreenTimeSeconds; // Atualiza localmente
            updateDigitalHourglassDisplay(currentUserData); // Atualiza a exibi√ß√£o

            screenTimeStatus.innerText = "Tempo registrado com sucesso!";
            screenTimeInput.value = ""; // Limpa o input
        } catch (error) {
            console.error("Erro ao registrar tempo de tela:", error);
            screenTimeStatus.innerText = "Erro ao registrar tempo. Tente novamente.";
        } finally {
            recordScreenTimeBtn.disabled = false;
        }
    });

    // Fun√ß√£o para upload de documentos (continua igual)
    uploadDocumentBtn.addEventListener("click", async () => {
        if (!currentUserData || !currentUserData.uid) {
            uploadStatus.innerText = "Erro: Usu√°rio n√£o logado.";
            return;
        }

        const file = documentUploadInput.files[0];
        const documentType = documentTypeSelect.value;

        if (!file) {
            uploadStatus.innerText = "Por favor, selecione um arquivo.";
            return;
        }
        if (!documentType) {
            uploadStatus.innerText = "Por favor, selecione o tipo de documento.";
            return;
        }

        uploadDocumentBtn.disabled = true;
        uploadStatus.innerText = "Fazendo upload...";

        try {
            // Cria um caminho √∫nico no Storage
            const storagePath = `users/${currentUserData.uid}/documents/${documentType}_${Date.now()}_${file.name}`;
            const storageRef = ref(storage, storagePath);

            // Faz o upload do arquivo
            const snapshot = await uploadBytes(storageRef, file);
            const downloadURL = await getDownloadURL(snapshot.ref);

            // Salva os metadados no Firestore
            const documentsCollectionRef = collection(db, "users", currentUserData.uid, "documents");
            await setDoc(doc(documentsCollectionRef), { // Adiciona um novo documento com ID autom√°tico
                type: documentType,
                filename: file.name,
                storagePath: storagePath,
                downloadURL: downloadURL,
                uploadDate: new Date(),
                status: "Pendente" // Ou "Em Revis√£o", "Verificado", etc.
            });

            uploadStatus.innerText = "Documento enviado com sucesso!";
            documentUploadInput.value = ""; // Limpa o input do arquivo
            documentTypeSelect.value = ""; // Limpa o tipo selecionado
            loadUserDocuments(currentUserData.uid); // Recarrega a lista de documentos
        } catch (error) {
            console.error("Erro ao fazer upload:", error);
            uploadStatus.innerText = `Erro ao fazer upload: ${error.message}`;
        } finally {
            uploadDocumentBtn.disabled = false;
        }
    });

    // Fun√ß√£o para carregar e exibir documentos do usu√°rio (continua igual)
    async function loadUserDocuments(uid) {
        uploadedDocumentsList.innerHTML = '<li>Carregando documentos... <span class="spinner"></span></li>';
        const documentsCollectionRef = collection(db, "users", uid, "documents");
        const q = query(documentsCollectionRef, orderBy("uploadDate", "desc"));

        try {
            const querySnapshot = await getDocs(q);
            if (querySnapshot.empty) {
                uploadedDocumentsList.innerHTML = '<li>Nenhum documento enviado ainda.</li>';
                return;
            }

            uploadedDocumentsList.innerHTML = ''; // Limpa a lista
            querySnapshot.forEach((doc) => {
                const docData = doc.data();
                const listItem = document.createElement("li");
                listItem.innerHTML = `
                    <span>${docData.type}: <a href="${docData.downloadURL}" target="_blank" rel="noopener noreferrer">${docData.filename}</a></span>
                    <small>(${new Date(docData.uploadDate.toDate()).toLocaleDateString()}) - Status: ${docData.status}</small>
                `;
                uploadedDocumentsList.appendChild(listItem);
            });
        } catch (error) {
            console.error("Erro ao carregar documentos:", error);
            uploadedDocumentsList.innerHTML = '<li>Erro ao carregar documentos.</li>';
        }
    }

    // Fun√ß√£o para Realizar Prova de Vida (continua igual)
    proofOfLifeBtn.addEventListener("click", async () => {
        if (!currentUserData || !currentUserData.uid) {
            proofOfLifeStatus.innerText = "Erro: Usu√°rio n√£o logado.";
            return;
        }

        proofOfLifeBtn.disabled = true;
        proofOfLifeStatus.innerText = "Realizando prova de vida...";

        try {
            const userDocRef = doc(db, "users", currentUserData.uid);
            // Incrementa tvt_bonus_days em 1
            const currentBonusDays = currentUserData.tvt_bonus_days || 0;
            const newBonusDays = currentBonusDays + 1;

            await updateDoc(userDocRef, {
                tvt_bonus_days: newBonusDays
            });
            currentUserData.tvt_bonus_days = newBonusDays; // Atualiza o objeto local

            // Registra o log da prova
            const proofsLogsCollectionRef = collection(db, "users", currentUserData.uid, "proofs_logs");
            await setDoc(doc(proofsLogsCollectionRef), {
                type: "proof_of_life",
                timestamp: new Date(),
                details: { days_added: 1, method: "manual_click" }, // Pode ser expandido com m√©todos de verifica√ß√£o reais
                tvt_snapshot_at_event: TVT_BASE_DAYS + calculateDaysLived(currentUserData.dateOfBirth) + newBonusDays
            });

            updateDigitalHourglassDisplay(currentUserData); // Atualiza a exibi√ß√£o
            proofOfLifeStatus.innerText = "Prova de vida realizada! +1 dia de valor atribu√≠do!";
        } catch (error) {
            console.error("Erro ao realizar prova de vida:", error);
            proofOfLifeStatus.innerText = "Erro ao realizar prova de vida. Tente novamente.";
        } finally {
            proofOfLifeBtn.disabled = false;
        }
    });

    // --- Listener de Autentica√ß√£o Global ---
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        // Usu√°rio logado
        console.log("Usu√°rio logado:", user.displayName, user.uid);
        loadingMessage.style.display = 'none';
        errorMessage.style.display = 'none';
        profileContent.style.display = 'block'; // Mostra o conte√∫do do perfil
        await loadUserProfile(user); // Carrega os dados do perfil
      } else {
        // Usu√°rio n√£o logado, redirecionar
        alert("Voc√™ precisa estar logado para acessar esta p√°gina. Redirecionando...");
        window.location.href = "./index.html";
      }
    });

    // --- Logout ---
    logoutBtn.addEventListener("click", async () => {
      try {
        await signOut(auth);
        window.location.href = "./index.html"; // Redireciona para a p√°gina de login
      } catch (error) {
        console.error("Erro ao fazer logout:", error);
        showPageErrorMessage("Erro ao fazer logout. Tente novamente.");
      }
    });

  </script>
</body>
</html>
