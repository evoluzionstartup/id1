<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Meu Perfil ID1</title>
  
  <!-- PWA: Link para o arquivo manifest.json -->
  <link rel="manifest" href="/manifest.json">

  <!-- D3.js e TopoJSON para o Mapa Interativo -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://unpkg.com/topojson-client@3"></script>

  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      text-align: center;
      background: #eef2f6; /* Fundo mais suave */
      color: #333;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      background: #2c3e50; /* Cor escura do cabe√ßalho */
      color: white;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    header .header-left {
      display: flex;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-size: 1.8rem;
      margin-left: 15px; /* Espa√ßo entre o √≠cone e o t√≠tulo */
    }
    header button {
      background: #e74c3c; /* Vermelho para sair */
      color: white;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.3s ease;
    }
    header button:hover {
      background-color: #c0392b;
    }

    /* √çcone de Perfil no Header */
    .profile-icon-header {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #4a90e2; /* Cor de fundo para placeholder */
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.5rem;
      color: white;
      cursor: pointer;
      border: 2px solid white; /* Borda branca */
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }
    .profile-icon-header:hover {
      transform: scale(1.05);
      box-shadow: 0 0 8px rgba(0,0,0,0.5);
    }
    .profile-icon-header::before {
      content: "üë§"; /* √çcone de usu√°rio simples */
    }

    /* Ampulheta Digital no Header */
    .header-hourglass {
      font-family: 'Consolas', 'Courier New', monospace;
      font-size: 1rem;
      color: #f0f0f0; /* Cor clara para contraste */
      background-color: rgba(0,0,0,0.3);
      padding: 0.3rem 0.6rem;
      border-radius: 5px;
      margin-left: 20px; /* Espa√ßo entre o t√≠tulo e a ampulheta */
      display: flex;
      align-items: center;
      gap: 5px; /* Espa√ßo entre o √≠cone e o texto */
    }
    .header-hourglass::before {
        content: "‚è≥"; /* √çcone de ampulheta */
        font-size: 1.2em;
    }


    main {
      flex-grow: 1;
      padding: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }

    /* Estilos das Abas */
    .tabs-container {
      width: 100%;
      max-width: 900px;
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      margin-top: 20px;
    }

    .tab-buttons {
      display: flex;
      border-bottom: 1px solid #ddd;
    }
    .tab-button {
      flex: 1;
      padding: 15px 0;
      cursor: pointer;
      font-size: 1.1rem;
      font-weight: bold;
      color: #555;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
    }
    .tab-button:hover {
      color: #4a90e2;
    }
    .tab-button.active {
      color: #4a90e2;
      border-bottom: 3px solid #4a90e2;
      background-color: #f9f9f9;
    }

    .tab-content {
      padding: 30px;
      text-align: left;
    }
    .tab-content.hidden {
      display: none;
    }

    /* Estilos dos Cards (dentro das abas) */
    .profile-card, .info-card, .section-card { /* Adicionado .section-card */
      background: #ffffff;
      padding: 0;
      border-radius: 8px;
      box-shadow: none;
      width: 100%;
      max-width: 800px;
      margin: 0 auto;
      text-align: left;
    }
    .profile-card h2, .info-card h2, .section-card h2, .section-card h3 { /* Adicionado .section-card */
      color: #34495e;
      margin-bottom: 25px;
      text-align: center;
      font-size: 2rem;
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #555;
      font-size: 1.05rem;
    }
    input[type="text"],
    input[type="email"],
    input[type="date"] {
      width: calc(100% - 22px);
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
      font-size: 1rem;
    }
    input[type="email"][readonly] {
      background-color: #f0f0f0;
      cursor: not-allowed;
    }
    .button-save {
      background: #28a745;
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1.1rem;
      transition: background-color 0.3s ease, transform 0.2s ease;
      width: auto;
      margin-top: 20px;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    .button-save:hover {
      background-color: #218838;
      transform: translateY(-2px);
    }
    .status-message {
      margin-top: 20px;
      font-size: 1rem;
      color: #e74c3c;
      text-align: center;
      font-weight: bold;
    }
    .success-message {
        color: #27ae60;
    }
    footer {
      background: #2c3e50;
      color: white;
      padding: 1rem;
      margin-top: auto;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
    }

    /* Estilo para o √≠cone de informa√ß√£o com popup */
    .info-icon-container {
      position: relative;
      display: inline-block;
      margin-left: 10px;
      cursor: pointer;
    }
    .info-icon {
      font-size: 1.2rem;
      color: #4a90e2;
      vertical-align: middle;
    }
    .info-popup {
      visibility: hidden;
      width: 250px;
      background-color: #555;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 10px;
      position: absolute;
      z-index: 1;
      bottom: 125%; /* Acima do √≠cone */
      left: 50%;
      margin-left: -125px; /* Centraliza o popup */
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 0.9rem;
    }
    .info-popup::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: #555 transparent transparent transparent;
    }
    .info-icon-container:hover .info-popup {
      visibility: visible;
      opacity: 1;
    }

    /* Estilos para homenagens e rel√≥gios */
    .time-section {
      background: #fdfdfd;
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      text-align: center;
    }
    .time-section h3 {
      color: #34495e;
      margin-bottom: 15px;
      font-size: 1.6rem;
    }
    .time-details p {
      font-size: 1.2rem;
      color: #444;
      margin-bottom: 5px;
    }
    .clock-display {
      font-family: 'Consolas', 'Courier New', monospace;
      font-size: 1.8rem;
      color: #2c3e50;
      font-weight: bold;
      letter-spacing: 1px;
      margin-top: 10px;
      background: #e0e6ec;
      padding: 10px;
      border-radius: 5px;
      display: inline-block;
    }
    .small-text {
      font-size: 0.9rem;
      color: #777;
    }
    .bold-value {
        font-weight: bold;
        color: #007bff; /* Azul para destacar valores */
    }

    /* Estilos para o Mapa */
    #world-map-container {
      width: 100%;
      max-width: 700px;
      height: 400px; /* Altura fixa para o mapa */
      margin: 20px auto;
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden; /* Garante que o mapa n√£o vaze */
      background-color: #e0f2f7; /* Cor de fundo do oceano */
      position: relative;
    }
    #world-map-container svg {
      width: 100%;
      height: 100%;
    }
    .country {
      fill: #a8dadc; /* Cor padr√£o dos pa√≠ses */
      stroke: #ffffff; /* Borda dos pa√≠ses */
      stroke-width: 0.5px;
      cursor: pointer;
      transition: fill 0.2s ease;
    }
    .country:hover {
      fill: #457b9d; /* Cor ao passar o mouse */
    }
    .country-label {
      font-size: 10px;
      fill: #333;
      pointer-events: none; /* N√£o interfere com cliques no pa√≠s */
    }
    #country-info-box {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px 15px;
      border-radius: 5px;
      font-size: 0.9rem;
      display: none; /* Escondido por padr√£o */
      white-space: nowrap; /* N√£o quebra linha */
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }

  </style>
</head>
<body>
  <header>
    <div class="header-left">
      <div class="profile-icon-header" id="headerProfileIcon" title="Meu Perfil"></div>
      <h1 id="headerTitle">ID1</h1> <!-- T√≠tulo alterado para "ID1" -->
      <div id="headerHourglass" class="header-hourglass">00h 00m 00s</div> <!-- Ampulheta Digital -->
    </div>
    <button id="logoutButton">Sair</button>
  </header>

  <main>
    <div class="tabs-container">
      <div class="tab-buttons">
        <button class="tab-button" data-tab="global-overview">Vis√£o Geral Global</button>
        <button class="tab-button" data-tab="profile">Meu Perfil</button>
        <button class="tab-button" data-tab="documents">Carteira de Documentos</button>
        <button class="tab-button" data-tab="tvv">TVV</button>
        <button class="tab-button" data-tab="tvt">TVT</button>
        <button class="tab-button" data-tab="tvdt">TVDT</button>
      </div>

      <!-- Aba: Vis√£o Geral Global -->
      <div id="global-overview-content" class="tab-content hidden">
        <h2>Vis√£o Geral Global
          <div class="info-icon-container">
            <span class="info-icon">‚ÑπÔ∏è</span>
            <div class="info-popup">
              Explore dados globais sobre a popula√ß√£o mundial e o impacto da Identidade Digital Evoluzion.
            </div>
          </div>
        </h2>
        
        <div class="section-card">
          <h3>Total de Identidades Digitais Emitidas</h3>
          <p class="small-text">Usu√°rios registrados na plataforma ID1.</p>
          <p class="highlight-number" id="globalUserCountDisplay">Carregando...</p>
        </div>

        <div class="section-card">
          <h3>Popula√ß√£o Mundial</h3>
          <p>A popula√ß√£o humana √© o nosso maior recurso. Estimamos a popula√ß√£o atual do planeta em:</p>
          <span id="worldPopulationDisplayGlobal" class="highlight-number">Carregando...</span>
          
          <h4>Fontes de Consulta:</h4>
          <ul>
            <li><a href="https://www.un.org/development/desa/pd/content/world-population-prospects" target="_blank" rel="noopener noreferrer">Na√ß√µes Unidas (ONU) - World Population Prospects</a></li>
            <li><a href="https://data.worldbank.org/indicator/SP.POP.TOTL" target="_blank" rel="noopener noreferrer">Banco Mundial - Popula√ß√£o Total</a></li>
            <li><a href="https://www.worldometers.info/br/" target="_blank" rel="noopener noreferrer">Worldometer - Contador de Popula√ß√£o Mundial (em tempo real)</a></li>
          </ul>
        </div>

        <div class="section-card">
          <h2>O Maior Ativo da Humanidade</h2>
          <p>Considerando que cada humano tenha o m√≠nimo de tempo de vida atribu√≠do de 122 anos, 5 meses e 14 dias (44724 dias), refer√™ncia √† vida de **Jeanne Louise Calment**, a pessoa com a vida mais longa verificada na hist√≥ria, o potencial de vida total da humanidade √©:</p>
          <span id="humanityAssetNumberGlobal" class="highlight-number">Calculando...</span>
          <p id="humanityAssetExtensoGlobal" class="number-extenso"></p>
          <p style="text-align: center; font-size: 1.2rem; font-weight: bold; color: #28a745; margin-top: 20px;">
            Esse √© o maior ativo da humanidade.
          </p>
        </div>

        <div class="section-card">
          <h3>Mapa Mundial Interativo</h3>
          <p class="small-text">Clique em um pa√≠s para ver sua popula√ß√£o (dados de exemplo).</p>
          <div id="world-map-container">
            <div id="country-info-box"></div>
          </div>
        </div>
      </div>

      <!-- Aba: Meu Perfil -->
      <div id="profile-content" class="tab-content hidden">
        <h2>Meus Dados
          <div class="info-icon-container">
            <span class="info-icon">‚ÑπÔ∏è</span>
            <div class="info-popup">
              Esta se√ß√£o permite que voc√™ visualize e edite suas informa√ß√µes pessoais. Seus dados s√£o armazenados de forma segura e utilizados para personalizar sua experi√™ncia.
            </div>
          </div>
        </h2>
        <p id="status" class="status-message"></p>

        <div class="form-group">
          <label for="nameInput">Nome Completo:</label>
          <input type="text" id="nameInput" placeholder="Seu Nome">
        </div>

        <div class="form-group">
          <label for="emailInput">E-mail:</label>
          <input type="email" id="emailInput" readonly>
          <small style="color: #666; display: block; margin-top: 5px;">Este campo n√£o pode ser alterado aqui.</small>
        </div>

        <div class="form-group">
          <label for="dateOfBirthInput">Data de Nascimento:</label>
          <input type="date" id="dateOfBirthInput">
        </div>

        <div class="form-group">
          <label for="placeOfBirthInput">Local de Nascimento:</label>
          <input type="text" id="placeOfBirthInput" placeholder="Cidade, Pa√≠s">
        </div>

        <button id="saveProfileButton" class="button-save">Salvar Perfil</button>
      </div>

      <!-- Aba: Carteira de Documentos -->
      <div id="documents-content" class="tab-content hidden">
        <h2>Carteira de Documentos
          <div class="info-icon-container">
            <span class="info-icon">‚ÑπÔ∏è</span>
            <div class="info-popup">
              Sua carteira digital para armazenar e gerenciar documentos importantes de forma segura e acess√≠vel, onde quer que voc√™ esteja. Recurso em desenvolvimento.
            </div>
          </div>
        </h2>
        <p>Sua carteira digital universal para documentos est√° em desenvolvimento.</p>
        <p>Em breve, voc√™ poder√° armazenar e acessar seus documentos de forma segura aqui.</p>
      </div>

      <!-- Aba: TVV (Tempo de Vida Vivido) -->
      <div id="tvv-content" class="tab-content hidden">
        <h2>TVV (Tempo de Vida Vivido)
          <div class="info-icon-container">
            <span class="info-icon">‚ÑπÔ∏è</span>
            <div class="info-popup">
              Aqui voc√™ pode ver uma contagem em tempo real de quanto tempo voc√™ viveu (se a data de nascimento estiver preenchida), al√©m de uma homenagem √† pessoa que mais viveu na hist√≥ria.
            </div>
          </div>
        </h2>

        <div class="time-section" id="myLifeCounterSection">
          <h3>Seu Tempo de Vida Real</h3>
          <p class="small-text">(Baseado na sua Data de Nascimento preenchida no Perfil)</p>
          <div class="clock-display" id="myLifeClock">
            <span id="myLifeYears">00</span>a <span id="myLifeMonths">00</span>m <span id="myLifeDays">00</span>d <span id="myLifeHours">00</span>h <span id="myLifeMinutes">00</span>m <span id="myLifeSeconds">00</span>s <span id="myLifeMilliseconds">000</span>ms
          </div>
          <p class="small-text" id="myLifeTotalValues">
            Voc√™ j√° viveu um total de <span class="bold-value" id="myLifeTotalYears">0</span> anos, 
            <span class="bold-value" id="myLifeTotalMonths">0</span> meses e 
            <span class="bold-value" id="myLifeTotalDays">0</span> dias.
          </p>
        </div>

        <div class="time-section">
          <h3>Homenagem a Jeanne Calment</h3>
          <p>A pessoa com a vida mais longa verificada na hist√≥ria.</p>
          <div class="time-details">
            <p><strong>Nome:</strong> Jeanne Louise Calment</p>
            <p><strong>Viveu:</strong> <span id="calmentYears"></span> anos, <span id="calmentMonths"></span> meses e <span id="calmentDays"></span> dias</p>
            <p class="small-text">(Total de: <span class="bold-value" id="calmentTotalYears"></span> anos | <span class="bold-value" id="calmentTotalMonths"></span> meses | <span class="bold-value" id="calmentTotalDays"></span> dias)</p>
          </div>
        </div>
      </div>

      <!-- Aba: TVT (Tempo de Vida Token) -->
      <div id="tvt-content" class="tab-content hidden">
        <h2>TVT (Tempo de Vida Token)
          <div class="info-icon-container">
            <span class="info-icon">‚ÑπÔ∏è</span>
            <div class="info-popup">
              O TVT √© o Tempo de Vida Token, uma medida baseada na maior longevidade j√° registrada, acrescida de um dia. Representa um valor de refer√™ncia para a potencialidade da vida.
            </div>
          </div>
        </h2>
        <p>Acompanhe o Tempo de Vida Token, que representa a maior longevidade j√° registrada, acrescida de um dia!</p>
        <div class="time-section">
          <h3>C√°lculo do TVT</h3>
          <p>F√≥rmula: (MAIOR LONGEVIDADE REGISTRADA + 1 dia)</p>
          <div class="clock-display" id="tvtDisplay">
            <span id="tvtYears">00</span>a <span id="tvtMonths">00</span>m <span id="tvtDays">00</span>d <span id="tvtHours">00</span>h <span id="tvtMinutes">00</span>m <span id="tvtSeconds">00</span>s <span id="tvtMilliseconds">000</span>ms
          </div>
          <p class="small-text">Este √© o valor de refer√™ncia do TVT.</p>
        </div>
        
        <div class="time-section">
          <h3>Total de Identidades Digitais</h3>
          <p class="small-text">N√∫mero de usu√°rios registrados na plataforma.</p>
          <p class="bold-value" id="totalRegisteredUsersCount">Carregando...</p>
        </div>
      </div>

      <!-- Aba: TVDT (Tempo de Vida Destinado √†s Telas) -->
      <div id="tvdt-content" class="tab-content hidden">
        <h2>TVDT (Tempo de Vida Destinado √†s Telas)
          <div class="info-icon-container">
            <span class="info-icon">‚ÑπÔ∏è</span>
            <div class="info-popup">
              O TVDT √© o Tempo de Vida Destinado √†s Telas, calculado com base no tempo que voc√™ passa logado no site, multiplicado por dois. Valorize seu tempo!
            </div>
          </div>
        </h2>
        <p>Acompanhe o tempo que voc√™ dedica √†s telas, valorizando cada segundo!</p>
        <div class="time-section">
          <h3>Seu Tempo Logado no Site</h3>
          <p class="small-text">Este √© o tempo acumulado que voc√™ permaneceu logado neste site.</p>
          <div class="clock-display" id="totalLoggedTimeDisplay">
            <span id="loggedHours">00</span>h <span id="loggedMinutes">00</span>m <span id="loggedSeconds">00</span>s <span id="loggedMilliseconds">000</span>ms
          </div>
        </div>

        <div class="time-section">
          <h3>TVDT Calculado (Tempo Logado x 2)</h3>
          <p class="small-text">F√≥rmula: (Seu Tempo Logado no Site x 2)</p>
          <div class="clock-display" id="tvdtCalculatedDisplay">
            <span id="tvdtHours">00</span>h <span id="tvdtMinutes">00</span>m <span id="tvdtSeconds">00</span>s <span id="tvdtMilliseconds">000</span>ms
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer>
    <p>&copy; 2025 Evoluzion. Todos os direitos reservados.</p>
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { 
      getAuth, 
      signOut, 
      onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { 
      getFirestore, 
      doc, 
      getDoc, 
      updateDoc,
      collection, 
      getCountFromServer 
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDUOF7BZIBNfJBXVmT2MGMMF6EBnUfsesk", // Use sua chave real
      authDomain: "evoluzion-id1.firebaseapp.com",
      projectId: "evoluzion-id1",
      storageBucket: "evoluzion-id1.appspot.com",
      messagingSenderId: "413091065593",
      appId: "1:413091065593:web:3527d66e02a2bf2f767c28"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- Constantes para o c√°lculo global ---
    // Estimativa de 8.233.166.345 em 07/07/2025 00:00:00 -03:00 (Hora local de Arauc√°ria)
    // Aumenta em aproximadamente 2.5 pessoas por segundo globalmente
    const INITIAL_WORLD_POPULATION_ESTIMATE = 8233166345; 
    const POPULATION_GROWTH_PER_SECOND = 2.5; // Estimativa de crescimento l√≠quido global por segundo
    const JEANNE_CALMENT_LIFESPAN_DAYS = 44724; // 122 anos, 5 meses e 14 dias em dias

    let currentWorldPopulationGlobal = INITIAL_WORLD_POPULATION_ESTIMATE;
    let lastUpdateTimeGlobal = Date.now();


    // --- DOM Elements - Perfil ---
    const statusText = document.getElementById("status");
    const nameInput = document.getElementById("nameInput");
    const emailInput = document.getElementById("emailInput");
    const dateOfBirthInput = document.getElementById("dateOfBirthInput");
    const placeOfBirthInput = document.getElementById("placeOfBirthInput");
    const saveProfileButton = document.getElementById("saveProfileButton");
    const logoutButton = document.getElementById("logoutButton");
    const headerProfileIcon = document.getElementById("headerProfileIcon");
    const headerTitle = document.getElementById("headerTitle"); // Novo: T√≠tulo do cabe√ßalho
    const headerHourglass = document.getElementById("headerHourglass"); // Novo: Ampulheta digital

    // --- DOM Elements - Abas ---
    const tabButtons = document.querySelectorAll(".tab-button");
    const tabContents = document.querySelectorAll(".tab-content");

    // --- DOM Elements - Vis√£o Geral Global ---
    const globalUserCountDisplay = document.getElementById("globalUserCountDisplay");
    const worldPopulationDisplayGlobal = document.getElementById("worldPopulationDisplayGlobal");
    const humanityAssetNumberGlobal = document.getElementById("humanityAssetNumberGlobal");
    const humanityAssetExtensoGlobal = document.getElementById("humanityAssetExtensoGlobal");
    const countryInfoBox = document.getElementById("country-info-box");


    // --- DOM Elements - Homenagem Jeanne Calment (no TVV) ---
    const calmentYearsSpan = document.getElementById("calmentYears");
    const calmentMonthsSpan = document.getElementById("calmentMonths");
    const calmentDaysSpan = document.getElementById("calmentDays");
    const calmentTotalYearsSpan = document.getElementById("calmentTotalYears");
    const calmentTotalMonthsSpan = document.getElementById("calmentTotalMonths");
    const calmentTotalDaysSpan = document.getElementById("calmentTotalDays");

    // --- DOM Elements - Seu Tempo de Vida (no TVV) ---
    const myLifeCounterSection = document.getElementById("myLifeCounterSection");
    const myLifeYearsSpan = document.getElementById("myLifeYears");
    const myLifeMonthsSpan = document.getElementById("myLifeMonths");
    const myLifeDaysSpan = document.getElementById("myLifeDays");
    const myLifeHoursSpan = document.getElementById("myLifeHours");
    const myLifeMinutesSpan = document.getElementById("myLifeMinutes");
    const myLifeSecondsSpan = document.getElementById("myLifeSeconds");
    const myLifeMillisecondsSpan = document.getElementById("myLifeMilliseconds");
    const myLifeTotalYearsSpan = document.getElementById("myLifeTotalYears");
    const myLifeTotalMonthsSpan = document.getElementById("myLifeTotalMonths");
    const myLifeTotalDaysSpan = document.getElementById("myLifeTotalDays");


    // --- DOM Elements - TVT ---
    const tvtDisplay = document.getElementById("tvtDisplay");
    const tvtYearsSpan = document.getElementById("tvtYears");
    const tvtMonthsSpan = document.getElementById("tvtMonths");
    const tvtDaysSpan = document.getElementById("tvtDays");
    const tvtHoursSpan = document.getElementById("tvtHours");
    const tvtMinutesSpan = document.getElementById("tvtMinutes");
    const tvtSecondsSpan = document.getElementById("tvtSeconds");
    const tvtMillisecondsSpan = document.getElementById("tvtMilliseconds");
    const totalRegisteredUsersCount = document.getElementById("totalRegisteredUsersCount");


    // --- DOM Elements - TVDT ---
    const totalLoggedTimeDisplay = document.getElementById("totalLoggedTimeDisplay");
    const loggedHoursSpan = document.getElementById("loggedHours");
    const loggedMinutesSpan = document.getElementById("loggedMinutes");
    const loggedSecondsSpan = document.getElementById("loggedSeconds");
    const loggedMillisecondsSpan = document.getElementById("loggedMilliseconds");

    const tvdtCalculatedDisplay = document.getElementById("tvdtCalculatedDisplay");
    const tvdtHoursSpan = document.getElementById("tvdtHours");
    const tvdtMinutesSpan = document.getElementById("tvdtMinutes");
    const tvdtSecondsSpan = document.getElementById("tvdtSeconds");
    const tvdtMillisecondsSpan = document.getElementById("tvdtMilliseconds");


    let userBirthDate = null;
    let accumulatedDigitalScreenTimeMs = 0; // Tempo total acumulado de uso do site (Firestore)
    let sessionStartTime = 0; // Marca o in√≠cio da sess√£o atual
    let sessionTimerInterval; // Intervalo para o timer da sess√£o
    let userHasLoggedInOnce = false;

    // --- Fun√ß√µes de Utilit√°rio de Data e Tempo ---

    function pad(num, length = 2) {
      return num.toString().padStart(length, '0');
    }

    function getExactAge(birthDate, endDate) {
      const start = new Date(birthDate.getTime());
      const end = new Date(endDate.getTime());

      let years = end.getFullYear() - start.getFullYear();
      let months = end.getMonth() - start.getMonth();
      let days = end.getDate() - start.getDate();

      if (days < 0) {
        months--;
        days += new Date(end.getFullYear(), end.getMonth(), 0).getDate();
      }
      if (months < 0) {
        years--;
        months += 12;
      }
      return { years, months, days };
    }

    function getTotalDuration(startDate, endDate) {
        const start = new Date(startDate);
        const end = new Date(endDate);

        const diffTime = Math.abs(end - start);
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        
        const totalYears = end.getFullYear() - start.getFullYear() - (end < new Date(end.getFullYear(), start.getMonth(), start.getDate()) ? 1 : 0);
        const totalMonths = totalYears * 12 + (end.getMonth() - start.getMonth()) - (end.getDate() < start.getDate() ? 1 : 0);
        
        return { totalYears, totalMonths, totalDays: diffDays };
    }

    function formatMillisecondsToHMS(ms) {
      const totalSeconds = Math.floor(ms / 1000);
      const totalMinutes = Math.floor(totalSeconds / 60);
      const totalHours = Math.floor(totalMinutes / 60);

      const hours = totalHours;
      const minutes = totalMinutes % 60;
      const seconds = totalSeconds % 60;
      const milliseconds = ms % 1000;

      return {
        hours: hours,
        minutes: minutes,
        seconds: seconds,
        milliseconds: milliseconds
      };
    }

    function formatMillisecondsToFullAge(ms) {
      const days = Math.floor(ms / (1000 * 60 * 60 * 24));
      let remainingMs = ms % (1000 * 60 * 60 * 24);

      const hours = Math.floor(remainingMs / (1000 * 60 * 60));
      remainingMs %= (1000 * 60 * 60);

      const minutes = Math.floor(remainingMs / (1000 * 60));
      remainingMs %= (1000 * 60);

      const seconds = Math.floor(remainingMs / 1000);
      const milliseconds = Math.floor(remainingMs % 1000);

      return { days, hours, minutes, seconds, milliseconds };
    }

    // --- Fun√ß√£o para converter n√∫mero para extenso em Portugu√™s (mais robusta) ---
    function numberToExtenso(num) {
        if (num === 0) return "zero";
        if (num < 0) return "menos " + numberToExtenso(Math.abs(num));

        const unidades = ["", "um", "dois", "tr√™s", "quatro", "cinco", "seis", "sete", "oito", "nove"];
        const especiais = ["dez", "onze", "doze", "treze", "quatorze", "quinze", "dezesseis", "dezessete", "dezoito", "dezenove"];
        const dezenas = ["", especiais[0], "vinte", "trinta", "quarenta", "cinquenta", "sessenta", "setenta", "oitenta", "noventa"];
        const centenas = ["", "cento", "duzentos", "trezentos", "quatrocentos", "quinhentos", "seiscentos", "setecentos", "oitocentos", "novecentos"];
        const grandezas = [
            ["", ""], ["mil", "mil"], ["milh√£o", "milh√µes"], ["bilh√£o", "bilh√µes"], ["trilh√£o", "trilh√µes"]
        ];

        function converterChunk(n) {
            let s = "";
            let c = Math.floor(n / 100);
            let d = Math.floor((n % 100) / 10);
            let u = n % 10;

            if (n === 100) return "cem";
            if (c > 0) s += centenas[c];

            if (d === 1 && u > 0) {
                if (s !== "") s += " e ";
                s += especiais[u];
            } else {
                if (d > 0) {
                    if (s !== "") s += " e ";
                    s += dezenas[d];
                }
                if (u > 0) {
                    if (s !== "" && (d !== 0 || c !== 0)) s += " e ";
                    else if (s !== "" && d === 0 && c === 0 && n !== 0) s += " e ";
                    s += unidades[u];
                }
            }
            return s;
        }

        let strNum = String(num);
        let chunks = [];
        while (strNum.length > 0) {
            chunks.unshift(parseInt(strNum.slice(-3), 10));
            strNum = strNum.slice(0, -3);
        }

        let resultado = [];
        for (let i = 0; i < chunks.length; i++) {
            let chunk = chunks[i];
            if (chunk === 0 && chunks.length > 1 && i !== chunks.length -1) continue;

            let textoChunk = converterChunk(chunk);
            let grandeza = grandezas[chunks.length - 1 - i];

            if (textoChunk !== "") {
                if (grandeza[0] !== "") {
                    if (chunk === 1 && grandeza[0] !== "mil") {
                        resultado.push(textoChunk + " " + grandeza[0]);
                    } else if (chunk > 1 && grandeza[1] !== "") {
                        resultado.push(textoChunk + " " + grandeza[1]);
                    } else {
                        resultado.push(textoChunk + (grandeza[0] ? " " + grandeza[0] : ""));
                    }
                } else {
                    resultado.push(textoChunk);
                }
            }
        }
        return resultado.join(" e ");
    }


    // --- Homenagem a Jeanne Calment (no TVV) ---
    const calmentBirthDate = new Date(Date.UTC(1875, 1, 21, 0, 0, 0));
    const calmentDeathDate = new Date(Date.UTC(1997, 7, 4, 0, 0, 0));

    function displayCalmentTribute() {
      const age = getExactAge(calmentBirthDate, calmentDeathDate);
      calmentYearsSpan.textContent = age.years;
      calmentMonthsSpan.textContent = age.months;
      calmentDaysSpan.textContent = age.days;

      const totalDuration = getTotalDuration(calmentBirthDate, calmentDeathDate);
      calmentTotalYearsSpan.textContent = totalDuration.totalYears;
      calmentTotalMonthsSpan.textContent = totalDuration.totalMonths;
      calmentTotalDaysSpan.textContent = totalDuration.totalDays;
    }

    // --- Seu Tempo de Vida (no TVV) ---
    let myLifeInterval;
    function updateMyLifeClock() {
      if (!userBirthDate) {
        myLifeCounterSection.style.display = 'none';
        return;
      } else {
        myLifeCounterSection.style.display = 'block';
      }

      const now = new Date();
      const diffMilliseconds = now - userBirthDate;

      if (diffMilliseconds < 0) {
        myLifeClock.textContent = "Data de nascimento futura!";
        myLifeTotalValues.textContent = "";
        return;
      }

      const ageExact = getExactAge(userBirthDate, now);
      myLifeYearsSpan.textContent = pad(ageExact.years);
      myLifeMonthsSpan.textContent = pad(ageExact.months);
      myLifeDaysSpan.textContent = pad(ageExact.days);

      let remainingMilliseconds = diffMilliseconds % (1000 * 60 * 60 * 24);

      const hours = Math.floor(remainingMilliseconds / (1000 * 60 * 60));
      remainingMilliseconds %= (1000 * 60 * 60);

      const minutes = Math.floor(remainingMilliseconds / (1000 * 60));
      remainingMilliseconds %= (1000 * 60);

      const seconds = Math.floor(remainingMilliseconds / 1000);
      const milliseconds = Math.floor(remainingMilliseconds % 1000);

      myLifeHoursSpan.textContent = pad(hours);
      myLifeMinutesSpan.textContent = pad(minutes);
      myLifeSecondsSpan.textContent = pad(seconds);
      myLifeMillisecondsSpan.textContent = pad(milliseconds, 3);

      const totalDuration = getTotalDuration(userBirthDate, now);
      myLifeTotalYearsSpan.textContent = totalDuration.totalYears;
      myLifeTotalMonthsSpan.textContent = totalDuration.totalMonths;
      myLifeTotalDaysSpan.textContent = totalDuration.totalDays;
    }

    // --- TVT (Tempo de Vida Token) ---
    let tvtInterval;
    function calculateAndDisplayTVT() {
      const calmentLifespanMs = calmentDeathDate.getTime() - calmentBirthDate.getTime();
      const oneDayMs = 24 * 60 * 60 * 1000;
      const tvtMs = calmentLifespanMs + oneDayMs;

      const duration = formatMillisecondsToFullAge(tvtMs);

      const theoreticalDeathDate = new Date(calmentBirthDate.getTime() + tvtMs); // Corre√ß√£o para usar tvtMs
      const tvtAgeExact = getExactAge(calmentBirthDate, theoreticalDeathDate);

      tvtYearsSpan.textContent = pad(tvtAgeExact.years);
      tvtMonthsSpan.textContent = pad(tvtAgeExact.months);
      tvtDaysSpan.textContent = pad(tvtAgeExact.days);
      tvtHoursSpan.textContent = pad(duration.hours);
      tvtMinutesSpan.textContent = pad(duration.minutes);
      tvtSecondsSpan.textContent = pad(duration.seconds);
      tvtMillisecondsSpan.textContent = pad(duration.milliseconds, 3);
    }

    // --- TVDT (Tempo de Vida Destinado √†s Telas) - L√≥gica Global ---
    function startSessionTracking() {
        if (!sessionTimerInterval) { // Inicia apenas se n√£o estiver j√° rodando
            sessionStartTime = Date.now(); // Marca o in√≠cio da sess√£o atual
            sessionTimerInterval = setInterval(updateSessionDisplay, 100); // Atualiza a cada 100ms
        }
    }

    async function stopSessionTracking() {
        if (sessionTimerInterval) {
            clearInterval(sessionTimerInterval);
            sessionTimerInterval = null;
        }
        
        // Calcula o tempo da sess√£o atual e adiciona ao acumulado
        const currentSessionDuration = Date.now() - sessionStartTime;
        if (currentSessionDuration > 0) {
            accumulatedDigitalScreenTimeMs += currentSessionDuration;
        }
        sessionStartTime = 0; // Reseta para a pr√≥xima sess√£o

        // Salva o tempo acumulado no Firestore
        const user = auth.currentUser;
        if (user) {
            try {
                await updateDoc(doc(db, "users", user.uid), {
                    accumulatedDigitalScreenTimeMs: accumulatedDigitalScreenTimeMs
                });
                console.log("Tempo de tela salvo com sucesso no Firestore.");
            } catch (error) {
                console.error("Erro ao salvar tempo de tela no Firestore:", error);
            }
        }
    }

    function updateSessionDisplay() {
        // Tempo da sess√£o atual
        const currentSessionDuration = Date.now() - sessionStartTime;
        const formattedSessionTime = formatMillisecondsToHMS(currentSessionDuration);
        headerHourglass.textContent = `${pad(formattedSessionTime.hours)}h ${pad(formattedSessionTime.minutes)}m ${pad(formattedSessionTime.seconds)}s`;

        // Atualiza a aba TVDT se estiver ativa
        if (!document.getElementById('tvdt-content').classList.contains('hidden')) {
            displayTVDTData();
        }
    }

    function displayTVDTData() {
        // Tempo Total Logado (acumulado de sess√µes anteriores + sess√£o atual)
        const totalCurrentLoggedMs = accumulatedDigitalScreenTimeMs + (Date.now() - sessionStartTime);
        const loggedFormatted = formatMillisecondsToHMS(totalCurrentLoggedMs);
        loggedHoursSpan.textContent = pad(loggedFormatted.hours);
        loggedMinutesSpan.textContent = pad(loggedFormatted.minutes);
        loggedSecondsSpan.textContent = pad(loggedFormatted.seconds);
        loggedMillisecondsSpan.textContent = pad(loggedFormatted.milliseconds, 3);

        // TVDT Calculado (Tempo Total Logado x 2)
        const tvdtCalculatedMs = totalCurrentLoggedMs * 2;
        const tvdtFormatted = formatMillisecondsToHMS(tvdtCalculatedMs);
        tvdtHoursSpan.textContent = pad(tvdtFormatted.hours);
        tvdtMinutesSpan.textContent = pad(tvdtFormatted.minutes);
        tvdtSecondsSpan.textContent = pad(tvdtFormatted.seconds);
        tvdtMillisecondsSpan.textContent = pad(tvdtFormatted.milliseconds, 3);
    }


    // --- Fun√ß√£o para obter a contagem total de usu√°rios registrados (para Vis√£o Geral Global e TVT) ---
    async function updateTotalRegisteredUsersCount() {
        try {
            const usersCollectionRef = collection(db, "users");
            const snapshot = await getCountFromServer(usersCollectionRef);
            globalUserCountDisplay.textContent = snapshot.data().count; // Para Vis√£o Geral Global
            totalRegisteredUsersCount.textContent = snapshot.data().count; // Para aba TVT
        } catch (error) {
            console.error("Erro ao obter contagem total de usu√°rios:", error);
            globalUserCountDisplay.textContent = "Erro ao carregar.";
            totalRegisteredUsersCount.textContent = "Erro ao carregar.";
        }
    }

    // --- Fun√ß√£o para simular e exibir a popula√ß√£o mundial em tempo real (para Vis√£o Geral Global) ---
    let worldPopulationIntervalGlobal;
    function updateWorldPopulationDisplayGlobal() {
        const now = Date.now();
        const elapsedTime = (now - lastUpdateTimeGlobal) / 1000;
        currentWorldPopulationGlobal += POPULATION_GROWTH_PER_SECOND * elapsedTime;
        lastUpdateTimeGlobal = now;
        worldPopulationDisplayGlobal.textContent = Math.floor(currentWorldPopulationGlobal).toLocaleString('pt-BR');
    }

    // --- Fun√ß√£o para calcular e exibir o "Maior Ativo da Humanidade" (para Vis√£o Geral Global) ---
    let humanityAssetIntervalGlobal;
    function displayHumanityAssetGlobal() {
        const totalAssetDays = Math.floor(currentWorldPopulationGlobal) * JEANNE_CALMENT_LIFESPAN_DAYS;
        humanityAssetNumberGlobal.textContent = totalAssetDays.toLocaleString('pt-BR') + " dias";
        humanityAssetExtensoGlobal.textContent = numberToExtenso(totalAssetDays) + " dias";
    }

    // --- Mapa Interativo (D3.js) ---
    const mapContainer = d3.select("#world-map-container");
    const width = 700;
    const height = 400;

    const svg = mapContainer.append("svg")
        .attr("viewBox", `0 0 ${width} ${height}`);

    const projection = d3.geoMercator()
        .scale(120)
        .center([0, 20])
        .translate([width / 2, height / 2]);

    const path = d3.geoPath().projection(projection);

    const countryPopulations = {
        "BRA": "215.000.000", "USA": "335.000.000", "CHN": "1.425.000.000", "IND": "1.428.000.000",
        "GBR": "67.000.000", "DEU": "83.000.000", "FRA": "65.000.000", "CAN": "40.000.000",
        "AUS": "26.000.000", "RUS": "144.000.000", "JPN": "123.000.000", "ZAF": "60.000.000",
        "ARG": "46.000.000", "MEX": "128.000.000", "ESP": "47.000.000", "ITA": "59.000.000",
        "NGA": "220.000.000", "IDN": "278.000.000", "EGY": "109.000.000", "PAK": "240.000.000",
        "BGD": "173.000.000", "NLD": "17.000.000", "BEL": "11.000.000", "SWE": "10.000.000",
        "NOR": "5.500.000", "DNK": "5.900.000", "FIN": "5.500.000", "POL": "37.000.000",
        "UKR": "37.000.000", "KOR": "51.000.000", "PRK": "26.000.000", "VNM": "99.000.000",
        "THA": "71.000.000", "PHL": "117.000.000", "TUR": "85.000.000", "IRN": "89.000.000",
        "SAU": "36.000.000", "COL": "52.0.000.000", "PER": "34.000.000", "CHL": "19.000.000",
        "VEN": "28.000.000", "CUB": "11.000.000", "GRC": "10.000.000", "PRT": "10.000.000",
        "CHE": "8.800.000", "AUT": "9.100.000", "IRL": "5.100.000", "NZL": "5.200.000",
        "EGY": "109.000.000", "KEN": "55.000.000", "ETH": "126.000.000", "CAN": "40.000.000"
    };


    d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json").then(world => {
        const countries = topojson.feature(world, world.objects.countries);

        svg.selectAll("path")
            .data(countries.features)
            .enter().append("path")
            .attr("class", "country")
            .attr("d", path)
            .on("click", function(event, d) {
                const countryName = d.properties.name;
                const countryCode = d.id; // ISO A3 code for some datasets
                const population = countryPopulations[countryCode] || "Dados n√£o dispon√≠veis";
                
                countryInfoBox.style.display = "block";
                countryInfoBox.textContent = `${countryName}: Pop. ~${population}`;
            });
        
        svg.on("click", function(event) {
            if (event.target.tagName === "svg" || event.target.classList.contains("country")) {
                // N√£o esconde se clicou no SVG ou em um pa√≠s (j√° tratado pelo click do pa√≠s)
            } else {
                countryInfoBox.style.display = "none";
            }
        });
    }).catch(error => {
        console.error("Erro ao carregar dados do mapa:", error);
        mapContainer.append("p").text("Erro ao carregar o mapa. Tente novamente mais tarde.");
    });


    // --- Listener de Autentica√ß√£o ---
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        emailInput.value = user.email || "N√£o dispon√≠vel";
        await loadUserProfile(user.uid);
        
        // Inicia o rastreamento do tempo de sess√£o assim que o usu√°rio est√° logado
        startSessionTracking();

        // Define a aba 'Vis√£o Geral Global' como ativa por padr√£o se o usu√°rio j√° preencheu dados
        if (userHasLoggedInOnce) {
          document.querySelector('.tab-button[data-tab="global-overview"]').click();
        } else {
          // Se for a primeira vez, mant√©m no perfil para preencher
          document.querySelector('.tab-button[data-tab="profile"]').click();
        }
      } else {
        // Se deslogado, para o rastreamento e redireciona
        stopSessionTracking(); // Garante que o tempo seja salvo antes de redirecionar
        window.location.href = "./index.html";
      }
    });

    // --- Carregar Dados do Perfil ---
    async function loadUserProfile(uid) {
      statusText.className = "status-message";
      statusText.innerText = "Carregando perfil...";
      try {
        const userRef = doc(db, "users", uid);
        const userSnap = await getDoc(userRef);

        if (userSnap.exists()) {
          const currentUserData = userSnap.data();
          nameInput.value = currentUserData.name || "";
          placeOfBirthInput.value = currentUserData.placeOfBirth || "";

          if (currentUserData.dateOfBirth && typeof currentUserData.dateOfBirth.toDate === 'function') {
            userBirthDate = currentUserData.dateOfBirth.toDate();
            dateOfBirthInput.value = userBirthDate.toISOString().split('T')[0];
          } else {
            dateOfBirthInput.value = "";
            userBirthDate = null;
          }
          
          // Carrega o tempo de tela acumulado do Firestore
          accumulatedDigitalScreenTimeMs = currentUserData.accumulatedDigitalScreenTimeMs || 0;

          if (currentUserData.name && currentUserData.dateOfBirth) {
            userHasLoggedInOnce = true;
          } else {
            userHasLoggedInOnce = false;
          }

          statusText.innerText = "";
        } else {
          statusText.innerText = "Documento de perfil n√£o encontrado. Crie um novo.";
          userBirthDate = null;
          accumulatedDigitalScreenTimeMs = 0;
          userHasLoggedInOnce = false;
        }
      } catch (error) {
        console.error("Erro ao carregar perfil:", error);
        statusText.innerText = `Erro ao carregar perfil: ${error.message}`;
        userBirthDate = null;
        accumulatedDigitalScreenTimeMs = 0;
        userHasLoggedInOnce = false;
      }
    }

    // --- Salvar Dados do Perfil ---
    saveProfileButton.addEventListener("click", async () => {
      const user = auth.currentUser;
      if (!user) {
        statusText.innerText = "Nenhum usu√°rio logado para salvar.";
        return;
      }

      statusText.className = "status-message";
      statusText.innerText = "Salvando perfil...";
      
      const updatedName = nameInput.value.trim();
      const updatedPlaceOfBirth = placeOfBirthInput.value.trim();
      const dobString = dateOfBirthInput.value;

      let updatedDateOfBirth = null;
      if (dobString) {
        try {
          updatedDateOfBirth = new Date(dobString + "T00:00:00Z"); 
          if (isNaN(updatedDateOfBirth.getTime())) {
            throw new Error("Data de nascimento inv√°lida.");
          }
        } catch (error) {
          statusText.innerText = `Erro na data de nascimento: ${error.message}`;
          return;
        }
      }

      try {
        const userRef = doc(db, "users", user.uid);
        await updateDoc(userRef, {
          name: updatedName,
          dateOfBirth: updatedDateOfBirth,
          placeOfBirth: updatedPlaceOfBirth
        }, { merge: true });

        userBirthDate = updatedDateOfBirth;
        
        if (updatedName && updatedDateOfBirth) {
            userHasLoggedInOnce = true;
        }

        statusText.innerText = "Perfil salvo com sucesso!";
        statusText.className = "status-message success-message";
      } catch (error) {
        console.error("Erro ao salvar perfil:", error);
        statusText.innerText = `Erro ao salvar perfil: ${error.message}`;
      }
    });

    // --- Sair (Logout) ---
    logoutButton.addEventListener("click", async () => {
      // stopSessionTracking() ser√° chamado pelo onAuthStateChanged quando o usu√°rio for null
      try {
        await signOut(auth);
        // O redirecionamento √© feito pelo onAuthStateChanged
      } catch (error) {
        console.error("Erro ao sair:", error);
        statusText.innerText = `Erro ao sair: ${error.message}`;
      }
    });

    // --- L√≥gica das Abas ---
    tabButtons.forEach(button => {
      button.addEventListener("click", () => {
        const targetTab = button.dataset.tab;

        tabButtons.forEach(btn => btn.classList.remove("active"));
        tabContents.forEach(content => content.classList.add("hidden"));

        button.classList.add("active");
        document.getElementById(`${targetTab}-content`).classList.remove("hidden");

        // Gerencia os intervalos espec√≠ficos de cada aba
        if (myLifeInterval) clearInterval(myLifeInterval);
        if (tvtInterval) clearInterval(tvtInterval);
        if (worldPopulationIntervalGlobal) clearInterval(worldPopulationIntervalGlobal);
        if (humanityAssetIntervalGlobal) clearInterval(humanityAssetIntervalGlobal);

        if (targetTab === 'tvv') {
          updateMyLifeClock();
          myLifeInterval = setInterval(updateMyLifeClock, 10);
        } else if (targetTab === 'tvt') {
          calculateAndDisplayTVT();
          updateTotalRegisteredUsersCount();
          tvtInterval = setInterval(calculateAndDisplayTVT, 10); // Mant√©m o TVT atualizando
        } else if (targetTab === 'tvdt') {
            displayTVDTData(); // Apenas exibe, o rastreamento √© global
        } else if (targetTab === 'global-overview') {
            updateTotalRegisteredUsersCount();
            worldPopulationIntervalGlobal = setInterval(updateWorldPopulationDisplayGlobal, 100);
            humanityAssetIntervalGlobal = setInterval(displayHumanityAssetGlobal, 100);
        }
      });
    });

    // --- √çcone de Perfil no Header ---
    headerProfileIcon.addEventListener("click", () => {
        document.querySelector('.tab-button[data-tab="profile"]').click();
    });

    // --- Inicializa√ß√£o ao Carregar a P√°gina ---
    document.addEventListener("DOMContentLoaded", () => {
      displayCalmentTribute();
      
      // O onAuthStateChanged vai lidar com o carregamento do perfil e o in√≠cio do rastreamento da sess√£o.
    });

    // --- Salvar tempo de tela acumulado ao fechar/navegar na p√°gina ---
    window.addEventListener('beforeunload', async () => {
        // Garante que o tempo da sess√£o atual seja salvo antes de sair
        await stopSessionTracking(); 
    });

  </script>

  <!-- PWA: Registro do Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .then((registration) => {
            console.log('Service Worker registrado com sucesso:', registration.scope);
          })
          .catch((error) => {
            console.error('Falha no registro do Service Worker:', error);
          });
      });
    }
  </script>
</body>
</html>
