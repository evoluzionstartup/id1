<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ID1 | Identidade Digital Evoluzion</title>
  
  <link rel="manifest" href="/manifest.json">

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, getCountFromServer } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // ATEN√á√ÉO: SUBSTITUA ESTA CONFIGURA√á√ÉO PELA SUA CONFIGURA√á√ÉO REAL DO FIREBASE!
    // Voc√™ pode encontr√°-la no seu Console do Firebase > Configura√ß√µes do Projeto > Seus Apps > Web.
    const firebaseConfig = {
      apiKey: "AIzaSyDUOF7BZIBNfJBXVmT2MGMMF6EBnUfsesk", // Substitua pela sua chave real
      authDomain: "evoluzion-id1.firebaseapp.com",
      projectId: "evoluzion-id1",
      storageBucket: "evoluzion-id1.appspot.com",
      messagingSenderId: "413091065593",
      appId: "1:413091065593:web:3527d66e02a2bf2f767c28"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const loginGoogleButton = document.getElementById("loginGoogle");
    const statusParagraph = document.getElementById("status");
    const userCountParagraph = document.getElementById("userCount");

    const provider = new GoogleAuthProvider();

    loginGoogleButton.addEventListener("click", async () => {
      try {
        statusParagraph.textContent = "Autenticando...";
        const result = await signInWithPopup(auth, provider);
        const user = result.user;

        // Verifica se o documento do usu√°rio j√° existe no Firestore
        const userRef = doc(db, "users", user.uid);
        const userSnap = await getDoc(userRef);

        if (!userSnap.exists()) {
          // Se n√£o existir, cria o documento com dados iniciais
          await setDoc(userRef, {
            email: user.email,
            name: user.displayName || "",
            createdAt: new Date(),
            // Adicionado campo para controle do tempo de tela para o PWA/App
            accumulatedDigitalScreenTimeMs: 0 
          }, { merge: true }); // Usar merge para garantir que outros campos n√£o sejam sobrescritos
          statusParagraph.textContent = "Novo usu√°rio registrado e logado!";
        } else {
          statusParagraph.textContent = "Usu√°rio existente logado!";
        }

        console.log("Usu√°rio logado:", user.displayName);
        window.location.href = "./perfil.html"; // Redireciona para a p√°gina de perfil
      } catch (error) {
        console.error("Erro no login:", error);
        statusParagraph.textContent = `Erro no login: ${error.message}`;
      }
    });

    // Fun√ß√£o para atualizar a contagem de usu√°rios
    async function updateUserCount() {
      try {
        console.log("Tentando obter contagem de usu√°rios...");
        const usersCollectionRef = collection(db, "users");
        const snapshot = await getCountFromServer(usersCollectionRef);
        userCountParagraph.textContent = `Total de identidades digitais emitidas: ${snapshot.data().count}`;
        console.log("Contagem de usu√°rios obtida com sucesso:", snapshot.data().count);
      } catch (error) {
        console.error("Erro ao obter contagem de usu√°rios:", error);
        userCountParagraph.textContent = "Erro ao carregar contagem.";
      }
    }

    // Monitora o estado de autentica√ß√£o para atualizar a contagem ou redirecionar
    onAuthStateChanged(auth, (user) => {
      if (user) {
        // Se j√° estiver logado, redireciona para o perfil imediatamente
        window.location.href = "./perfil.html";
      } else {
        // Se n√£o estiver logado, apenas atualiza a contagem
        updateUserCount();
      }
    });

    // Garante que a contagem seja atualizada ao carregar a p√°gina se o usu√°rio n√£o estiver logado
    document.addEventListener("DOMContentLoaded", () => {
      // A verifica√ß√£o onAuthStateChanged j√° cuida do carregamento inicial e redirecionamento.
      // Esta parte garante que a contagem seja atualizada se o usu√°rio N√ÉO estiver logado.
      if (!auth.currentUser) { // Verifica o estado atual do usu√°rio
          updateUserCount();
      }
    });
  </script>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 0; 
      padding: 0; 
      text-align: center; 
      background: #f5f5f5; 
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header { 
      background: #0c0c0c; 
      color: white; 
      padding: 1rem; 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    header h1 { 
      margin: 0; 
      font-size: 1.5rem; 
    }
    header button { 
      background: white; 
      color: black; 
      border: none; 
      padding: 0.5rem 1rem; 
      border-radius: 5px; 
      cursor: pointer; 
      font-size: 1rem;
      transition: background-color 0.3s ease;
    }
    header button:hover {
      background-color: #eee;
    }
    main { 
      flex-grow: 1;
      padding: 2rem; 
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .mapa { 
      width: 100%; 
      max-width: 600px; 
      margin: auto; 
      background: #ddd; 
      padding: 2rem; 
      border-radius: 1rem; 
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    footer { 
      background: #0c0c0c; 
      color: white; 
      padding: 1rem; 
      margin-top: auto; 
      box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
    }
    h2 {
        color: #333;
        margin-bottom: 1rem;
    }
    p {
        color: #555;
        line-height: 1.6;
    }
    #status {
        font-weight: bold;
        color: #e74c3c;
        margin-top: 1rem;
    }
    #userCount {
        font-weight: bold;
        color: #2c3e50;
        font-size: 1.1rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>ID1: Identidade Digital Evoluzion</h1>
    <button id="loginGoogle">Login com Google</button>
  </header>

  <main>
    <h2>üåç Bem-vindo √† identidade digital universal</h2>
    <p>Uma s√≥ identidade. Um s√≥ planeta. Um s√≥ povo.</p>
    <p id="status"></p>
    <p id="userCount">Total de identidades digitais emitidas: Carregando...</p>

    <div class="mapa">
        <p>Imagine o mapa mundial da vida de cada pessoa. üó∫Ô∏è</p>
        <p>Seus dados s√£o um ponto valioso nessa jornada global.</p>
    </div>
  </main>

  <footer>
    <p>&copy; 2025 Evoluzion. Todos os direitos reservados.</p>
  </footer>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .then((registration) => {
            console.log('Service Worker registrado com sucesso:', registration.scope);
          })
          .catch((error) => {
            console.error('Falha no registro do Service Worker:', error);
          });
      });
    }
  </script>
</body>
</html>
