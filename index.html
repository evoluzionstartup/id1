<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ID1 | Identidade Digital Evoluzion</title>
  <style>
    /* Estilos gerais */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      text-align: center;
      background: #f5f5f5;
      color: #333;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      background: #2c3e50; /* Cor mais escura para o cabe√ßalho */
      color: white;
      padding: 1rem 2rem;
      display: flex;
      justify-content: center; /* Centraliza o t√≠tulo */
      align-items: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    header h1 {
      margin: 0;
      font-size: 1.8rem;
    }
    main {
      flex-grow: 1; /* Permite que o conte√∫do principal ocupe o espa√ßo restante */
      padding: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .welcome-section {
      margin-bottom: 30px;
    }
    .welcome-section h2 {
      color: #34495e;
      font-size: 2.2rem;
      margin-bottom: 10px;
    }
    .welcome-section p {
      font-size: 1.1rem;
      color: #555;
    }
    .login-card {
      background: #ffffff;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 450px; /* Limita a largura do cart√£o de login */
      margin: 20px auto;
      text-align: left;
    }
    .login-card h3 {
      color: #34495e;
      margin-bottom: 20px;
      text-align: center;
      font-size: 1.5rem;
    }
    .button {
      background: #4a90e2; /* Azul vibrante */
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1.05rem;
      transition: background-color 0.3s ease, transform 0.2s ease;
      width: 100%;
      box-sizing: border-box;
      margin-bottom: 15px; /* Espa√ßo entre bot√µes */
    }
    .button:hover {
      background-color: #357bd8;
      transform: translateY(-2px);
    }
    .button-google {
      background: #db4437; /* Vermelho Google */
    }
    .button-google:hover {
      background-color: #c23321;
    }
    .button-anonymous {
      background: #6c757d; /* Cinza */
    }
    .button-anonymous:hover {
      background-color: #5a6268;
    }
    input[type="email"],
    input[type="password"],
    input[type="tel"],
    input[type="text"] {
      width: calc(100% - 22px); /* Com padding */
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 1rem;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #555;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .status-message {
      margin-top: 20px;
      font-size: 1rem;
      color: #e74c3c; /* Vermelho para erros */
      text-align: center;
      font-weight: bold;
    }
    .success-message {
        color: #27ae60; /* Verde para sucesso */
    }
    #recaptcha-container {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 20px;
    }
    .mapa {
      width: 100%;
      max-width: 600px;
      margin: 30px auto;
      background: #e9ecef;
      padding: 2.5rem;
      border-radius: 10px;
      border: 1px solid #dee2e6;
      text-align: center;
    }
    .mapa h3 {
      color: #495057;
    }
    .user-count {
      margin-top: 20px;
      font-size: 1.1rem;
      color: #6c757d;
      font-weight: bold;
    }
    footer {
      background: #2c3e50;
      color: white;
      padding: 1rem;
      margin-top: auto; /* Empurra o footer para o final da p√°gina */
      box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <header>
    <h1>ID1: Identidade Digital Evoluzion</h1>
  </header>

  <main>
    <section class="welcome-section">
      <h2>üåç Bem-vindo √† identidade digital universal</h2>
      <p>Uma s√≥ identidade. Um s√≥ planeta. Um s√≥ povo.</p>
    </section>

    <div class="login-card">
      <h3>Entrar ou Cadastrar</h3>
      <p id="status" class="status-message"></p>

      <button id="loginGoogle" class="button button-google">Login com Google</button>

      <hr style="border: 0; border-top: 1px solid #eee; margin: 25px 0;">

      <h4>E-mail e Senha</h4>
      <div class="form-group">
        <label for="emailInput">E-mail:</label>
        <input type="email" id="emailInput" placeholder="seuemail@exemplo.com">
      </div>
      <div class="form-group">
        <label for="passwordInput">Senha:</label>
        <input type="password" id="passwordInput" placeholder="********">
      </div>
      <button id="loginEmail" class="button">Entrar com E-mail</button>
      <button id="registerEmail" class="button">Registrar com E-mail</button>

      <hr style="border: 0; border-top: 1px solid #eee; margin: 25px 0;">

      <button id="loginAnonymous" class="button button-anonymous">Entrar como An√¥nimo</button>
      
      <hr style="border: 0; border-top: 1px solid #eee; margin: 25px 0;">

      <h4>Telefone</h4>
      <div class="form-group">
        <label for="phoneInput">N√∫mero de Telefone:</label>
        <input type="tel" id="phoneInput" placeholder="+55 (XX) XXXXX-XXXX">
        <small style="color: #666;">Inclua o c√≥digo do pa√≠s e DDD (Ex: +5511987654321)</small>
      </div>
      <div id="recaptcha-container"></div>
      <button id="sendSmsCode" class="button">Enviar C√≥digo SMS</button>

      <div id="verifyCodeSection" style="display: none; margin-top: 20px;">
        <label for="smsCodeInput">C√≥digo SMS:</label>
        <input type="text" id="smsCodeInput" placeholder="XXXXXX">
        <button id="verifySmsCode" class="button">Verificar C√≥digo</button>
      </div>
    </div>

    <p id="userCount" class="user-count">Total de usu√°rios ID1: carregando...</p>

    <div class="mapa">
      <h3>Mapa Mundial Interativo (em breve)</h3>
      <p>Aqui voc√™ poder√° ver o n√∫mero de usu√°rios por pa√≠s e acessar documentos oficiais de cada na√ß√£o.</p>
      <p>üîí Seus dados s√£o protegidos e pertencem apenas a voc√™.</p>
    </div>
  </main>

  <footer>
    <p>&copy; 2025 Evoluzion. Todos os direitos reservados.</p>
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { 
      getAuth, 
      signInWithPopup, 
      GoogleAuthProvider, 
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signInAnonymously,
      RecaptchaVerifier,
      signInWithPhoneNumber,
      onAuthStateChanged // Mantido, mas usado de forma diferente
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, getCountFromServer, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"; // Importado updateDoc

    // Sua configura√ß√£o do Firebase (Garanta que esta √© a COPIA EXATA do seu Console do Firebase)
    const firebaseConfig = {
      apiKey: "AIzaSyDUOF7BZIBNfJBXVmT2MGMMF6EBnUfsesk", // Use sua chave real
      authDomain: "evoluzion-id1.firebaseapp.com",
      projectId: "evoluzion-id1",
      storageBucket: "evoluzion-id1.appspot.com",
      messagingSenderId: "413091065593",
      appId: "1:413091065593:web:3527d66e02a2bf2f767c28"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let confirmationResult; // Para login com telefone

    // --- VERIFICA√á√ÉO INICIAL DE AUTENTICA√á√ÉO AO CARREGAR A P√ÅGINA ---
    // Se o usu√°rio J√Å ESTIVER logado de uma sess√£o anterior, redireciona IMEDIATAMENTE.
    if (auth.currentUser) {
      window.location.href = "./perfil.html";
    }

    document.addEventListener("DOMContentLoaded", () => {
      // DOM Elements
      const statusText = document.getElementById("status");
      const userCountText = document.getElementById("userCount");

      // Google Login
      const loginGoogleBtn = document.getElementById("loginGoogle");

      // Email/Password Login
      const emailInput = document.getElementById("emailInput");
      const passwordInput = document.getElementById("passwordInput");
      const loginEmailBtn = document.getElementById("loginEmail");
      const registerEmailBtn = document.getElementById("registerEmail");

      // Anonymous Login
      const loginAnonymousBtn = document.getElementById("loginAnonymous");

      // Phone Login
      const phoneInput = document.getElementById("phoneInput");
      const recaptchaContainer = document.getElementById("recaptcha-container");
      const sendSmsCodeBtn = document.getElementById("sendSmsCode");
      const verifyCodeSection = document.getElementById("verifyCodeSection");
      const smsCodeInput = document.getElementById("smsCodeInput");
      const verifySmsCodeBtn = document.getElementById("verifySmsCode");

      // --- Google Login ---
      loginGoogleBtn.addEventListener("click", async () => {
        const provider = new GoogleAuthProvider();
        try {
          statusText.innerText = "Fazendo login com Google...";
          const result = await signInWithPopup(auth, provider);
          const user = result.user;
          await createUserDocumentIfNew(user);
          window.location.href = "./perfil.html";
        } catch (error) {
          console.error("Erro no login com Google:", error);
          statusText.innerText = `Erro ao logar com Google: ${error.message}`;
        }
      });

      // --- Email/Password Login ---
      loginEmailBtn.addEventListener("click", async () => {
        const email = emailInput.value;
        const password = passwordInput.value;
        if (!email || !password) {
          statusText.innerText = "Por favor, preencha e-mail e senha.";
          return;
        }
        try {
          statusText.innerText = "Fazendo login com e-mail...";
          const result = await signInWithEmailAndPassword(auth, email, password);
          const user = result.user;
          await createUserDocumentIfNew(user);
          window.location.href = "./perfil.html";
        } catch (error) {
          console.error("Erro no login com E-mail:", error);
          statusText.innerText = `Erro ao logar com E-mail: ${error.message}`;
        }
      });

      // --- Email/Password Registration ---
      registerEmailBtn.addEventListener("click", async () => {
        const email = emailInput.value;
        const password = passwordInput.value;
        if (!email || !password) {
          statusText.innerText = "Por favor, preencha e-mail e senha para se registrar.";
          return;
        }
        try {
          statusText.innerText = "Registrando com e-mail...";
          const result = await createUserWithEmailAndPassword(auth, email, password);
          const user = result.user;
          await createUserDocumentIfNew(user, email);
          window.location.href = "./perfil.html";
        } catch (error) {
          console.error("Erro no registro com E-mail:", error);
          statusText.innerText = `Erro ao registrar com E-mail: ${error.message}`;
        }
      });

      // --- Anonymous Login ---
      loginAnonymousBtn.addEventListener("click", async () => {
        try {
          statusText.innerText = "Entrando como an√¥nimo...";
          const result = await signInAnonymously(auth);
          const user = result.user;
          await createUserDocumentIfNew(user, "Usu√°rio An√¥nimo");
          window.location.href = "./perfil.html";
        } catch (error) {
          console.error("Erro no login An√¥nimo:", error);
          statusText.innerText = `Erro ao logar como an√¥nimo: ${error.message}`;
        }
      });

      // --- Phone Login (Recaptcha e SMS) ---
      // Inicializa o reCAPTCHA Verifier
      // A vari√°vel window.recaptchaVerifier √© importante para o Firebase Auth.
      window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
        'size': 'normal',
        'callback': (response) => {
          sendSmsCodeBtn.disabled = false;
        },
        'expired-callback': () => {
          sendSmsCodeBtn.disabled = true;
          statusText.innerText = "ReCAPTCHA expirou, por favor, tente novamente.";
        }
      });
      // Renderiza o reCAPTCHA na p√°gina
      recaptchaVerifier.render().then((widgetId) => {
        window.recaptchaWidgetId = widgetId;
      });
      
      sendSmsCodeBtn.addEventListener("click", async () => {
        const phoneNumber = phoneInput.value;
        if (!phoneNumber) {
          statusText.innerText = "Por favor, insira um n√∫mero de telefone.";
          return;
        }
        statusText.innerText = "Enviando c√≥digo SMS...";
        sendSmsCodeBtn.disabled = true;

        try {
          confirmationResult = await signInWithPhoneNumber(auth, phoneNumber, window.recaptchaVerifier);
          verifyCodeSection.style.display = 'block';
          statusText.innerText = "C√≥digo SMS enviado. Verifique seu telefone.";
        } catch (error) {
          console.error("Erro ao enviar c√≥digo SMS:", error);
          statusText.innerText = `Erro ao enviar c√≥digo: ${error.message}`;
          sendSmsCodeBtn.disabled = false;
          if (window.recaptchaVerifier && window.recaptchaWidgetId) {
            window.recaptchaVerifier.reset(window.recaptchaWidgetId);
          }
        }
      });

      verifySmsCodeBtn.addEventListener("click", async () => {
        const code = smsCodeInput.value;
        if (!code) {
          statusText.innerText = "Por favor, insira o c√≥digo SMS.";
          return;
        }
        statusText.innerText = "Verificando c√≥digo...";
        verifySmsCodeBtn.disabled = true;

        try {
          const result = await confirmationResult.confirm(code);
          const user = result.user;
          await createUserDocumentIfNew(user, user.phoneNumber);
          window.location.href = "./perfil.html";
        } catch (error) {
          console.error("Erro ao verificar c√≥digo SMS:", error);
          statusText.innerText = `Erro ao verificar c√≥digo: ${error.message}`;
          verifySmsCodeBtn.disabled = false;
        }
      });

      // --- Helper para criar documento do usu√°rio no Firestore se for novo ---
      async function createUserDocumentIfNew(user, defaultName = null) {
        const userRef = doc(db, "users", user.uid);
        const userSnap = await getDoc(userRef);
        if (!userSnap.exists()) {
          let nameToSet = user.displayName || defaultName || user.email || user.phoneNumber || `Usu√°rio ${user.uid.substring(0, 8)}`;
          
          await setDoc(userRef, {
            uid: user.uid,
            name: nameToSet,
            email: user.email || null,
            phoneNumber: user.phoneNumber || null,
            createdAt: new Date(),
            lastLoginAt: new Date()
          }, { merge: true });
        } else {
          await updateDoc(userRef, {
            lastLoginAt: new Date()
          });
        }
      }

      // --- Contador de Usu√°rios ---
      async function updateUserCount() {
        try {
          const coll = collection(db, "users");
          const snapshot = await getCountFromServer(coll);
          userCountText.innerText = `Total de usu√°rios ID1: ${snapshot.data().count}`;
        } catch (error) {
          console.error("Erro ao obter a contagem de usu√°rios:", error);
          userCountText.innerText = `Total de usu√°rios ID1: Erro ao carregar.`;
        }
      }

      // Atualiza o contador de usu√°rios quando o DOM estiver pronto
      updateUserCount();
    });
  </script>
</body>
</html>
